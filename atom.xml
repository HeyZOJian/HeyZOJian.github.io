<?xml version="1.0" encoding="utf-8"?>
<feed xmlns="http://www.w3.org/2005/Atom">
  <title>Hexo</title>
  
  
  <link href="/atom.xml" rel="self"/>
  
  <link href="http://yoursite.com/"/>
  <updated>2018-04-08T13:47:16.393Z</updated>
  <id>http://yoursite.com/</id>
  
  <author>
    <name>John Doe</name>
    
  </author>
  
  <generator uri="http://hexo.io/">Hexo</generator>
  
  <entry>
    <title>vue axios post出现&quot;CSRF token missing or incorrect&quot;</title>
    <link href="http://yoursite.com/2018/04/08/vue-axios-post%E5%87%BA%E7%8E%B0CSRF-token-missing-or-incorrect/"/>
    <id>http://yoursite.com/2018/04/08/vue-axios-post出现CSRF-token-missing-or-incorrect/</id>
    <published>2018-04-08T13:44:45.000Z</published>
    <updated>2018-04-08T13:47:16.393Z</updated>
    
    <content type="html"><![CDATA[<ol><li>登陆后保存服务器返回的<code>csrftoken</code>到localstore</li><li><p>创建axios时添加<code>X-CSRFTOKEN</code>头部</p><figure class="highlight javascript"><table><tr><td class="gutter"><pre><div class="line">1</div><div class="line">2</div><div class="line">3</div></pre></td><td class="code"><pre><div class="line"><span class="keyword">var</span> instance = axios.create(&#123;</div><div class="line">            <span class="attr">headers</span>:&#123;<span class="string">'X-CSRFTOKEN'</span>:localStorage.getItem(<span class="string">'csrftoken'</span>) &#125;</div><div class="line">        &#125;)</div></pre></td></tr></table></figure></li><li><p>解决</p></li></ol>]]></content>
    
    <summary type="html">
    
      
      
        &lt;ol&gt;
&lt;li&gt;登陆后保存服务器返回的&lt;code&gt;csrftoken&lt;/code&gt;到localstore&lt;/li&gt;
&lt;li&gt;&lt;p&gt;创建axios时添加&lt;code&gt;X-CSRFTOKEN&lt;/code&gt;头部&lt;/p&gt;
&lt;figure class=&quot;highlight javascri
      
    
    </summary>
    
    
      <category term="Django" scheme="http://yoursite.com/tags/Django/"/>
    
      <category term="Vue" scheme="http://yoursite.com/tags/Vue/"/>
    
  </entry>
  
  <entry>
    <title>HAPPY NEW YEAR 2018</title>
    <link href="http://yoursite.com/2018/02/15/HAPPY-NEW-YEAR-2018/"/>
    <id>http://yoursite.com/2018/02/15/HAPPY-NEW-YEAR-2018/</id>
    <published>2018-02-15T09:29:10.000Z</published>
    <updated>2018-02-17T09:41:44.487Z</updated>
    
    <content type="html"><![CDATA[<p>2017年过去了，拿到各种证，考（不）过研，无悔<br><a id="more"></a><br><del>家人身体健康</del><br><del>蓝桥杯省赛拿个一等去北京旅游</del><br><del>ACM省赛拿个铜牌结束自己的生涯</del><br>找个女朋友？<br>暑假找个满意的实习<br>去个没去过的地旅游<br><del>体重控制在140-150</del><br>早睡早起</p><p>//2018</p><ul><li>家人身体健康</li><li>初试350+</li><li>找个满意的工作~</li><li>顺利毕业~</li><li>早睡早起</li></ul>]]></content>
    
    <summary type="html">
    
      &lt;p&gt;2017年过去了，拿到各种证，考（不）过研，无悔&lt;br&gt;
    
    </summary>
    
    
      <category term="杂" scheme="http://yoursite.com/tags/%E6%9D%82/"/>
    
  </entry>
  
  <entry>
    <title>Django REST framework 教程6：Viewsets和Routers</title>
    <link href="http://yoursite.com/2018/02/12/Django-REST-framework-%E6%95%99%E7%A8%8B6%EF%BC%9AViewsets%E5%92%8CRouters/"/>
    <id>http://yoursite.com/2018/02/12/Django-REST-framework-教程6：Viewsets和Routers/</id>
    <published>2018-02-12T06:56:06.000Z</published>
    <updated>2018-02-17T09:42:30.149Z</updated>
    
    <summary type="html">
    
    </summary>
    
    
      <category term="Django" scheme="http://yoursite.com/tags/Django/"/>
    
      <category term="Django REST framework" scheme="http://yoursite.com/tags/Django-REST-framework/"/>
    
      <category term="翻译" scheme="http://yoursite.com/tags/%E7%BF%BB%E8%AF%91/"/>
    
  </entry>
  
  <entry>
    <title>Django REST framework 教程5：关系和超链接API</title>
    <link href="http://yoursite.com/2018/02/12/Django-REST-framework-%E6%95%99%E7%A8%8B5%EF%BC%9A%E5%85%B3%E7%B3%BB%E5%92%8C%E8%B6%85%E9%93%BE%E6%8E%A5API/"/>
    <id>http://yoursite.com/2018/02/12/Django-REST-framework-教程5：关系和超链接API/</id>
    <published>2018-02-12T06:55:22.000Z</published>
    <updated>2018-02-17T09:42:34.976Z</updated>
    
    <summary type="html">
    
    </summary>
    
    
      <category term="Django" scheme="http://yoursite.com/tags/Django/"/>
    
      <category term="Django REST framework" scheme="http://yoursite.com/tags/Django-REST-framework/"/>
    
      <category term="翻译" scheme="http://yoursite.com/tags/%E7%BF%BB%E8%AF%91/"/>
    
  </entry>
  
  <entry>
    <title>Django REST framework 教程4：认证与权限</title>
    <link href="http://yoursite.com/2018/02/12/Django-REST-framework-%E6%95%99%E7%A8%8B4%EF%BC%9A%E8%AE%A4%E8%AF%81%E4%B8%8E%E6%9D%83%E9%99%90/"/>
    <id>http://yoursite.com/2018/02/12/Django-REST-framework-教程4：认证与权限/</id>
    <published>2018-02-12T06:55:03.000Z</published>
    <updated>2018-02-12T13:25:07.745Z</updated>
    
    <content type="html"><![CDATA[<p>目前我们的API没有限制谁可以编辑和删除代码片段。我们想要一些更高级的行为来确保：<br><a id="more"></a></p><ul><li>代码片段与创建者关联</li><li>只有注册了的用户才可以创建代码片段</li><li>只有创建者才能更新或者删除代码片段</li><li>未经身份认证的请求只能浏览代码片段</li></ul><h2 id="在我们的模型中添加一些信息"><a href="#在我们的模型中添加一些信息" class="headerlink" title="在我们的模型中添加一些信息"></a>在我们的模型中添加一些信息</h2><p>我们将对<code>Snippet</code>模型进行一些修改。首先，添加一些字段。第一个字段被用来表示该片段是由哪个用户创建的。另一个被用来存储高亮显示的片段的HTML代码。</p><p>在<code>models.py</code>中的<code>Snippet</code>模型中添加以下两个字段。</p><figure class="highlight python"><table><tr><td class="gutter"><pre><div class="line">1</div><div class="line">2</div></pre></td><td class="code"><pre><div class="line">owner = models.ForeignKey(<span class="string">'auth.User'</span>, related_name=<span class="string">'snippets'</span>, on_delete=models.CASCADE)</div><div class="line">highlighted = models.TextField()</div></pre></td></tr></table></figure><p>我们得确保当模型存储时，用<code>pygments</code>代码高亮库去填充高亮字段。</p><p>所有还有导入一些东西：</p><figure class="highlight python"><table><tr><td class="gutter"><pre><div class="line">1</div><div class="line">2</div><div class="line">3</div></pre></td><td class="code"><pre><div class="line"><span class="keyword">from</span> pygments.lexers <span class="keyword">import</span> get_lexer_by_name</div><div class="line"><span class="keyword">from</span> pygments.formatters.html <span class="keyword">import</span> HtmlFormatter</div><div class="line"><span class="keyword">from</span> pygments <span class="keyword">import</span> highlight</div></pre></td></tr></table></figure><p>然后在模型类中添加<code>.save（）</code>方法：</p><figure class="highlight python"><table><tr><td class="gutter"><pre><div class="line">1</div><div class="line">2</div><div class="line">3</div><div class="line">4</div><div class="line">5</div><div class="line">6</div><div class="line">7</div><div class="line">8</div><div class="line">9</div><div class="line">10</div><div class="line">11</div><div class="line">12</div></pre></td><td class="code"><pre><div class="line"><span class="function"><span class="keyword">def</span> <span class="title">save</span><span class="params">(self, *args, **kwargs)</span>:</span></div><div class="line">    <span class="string">"""</span></div><div class="line">    Use the `pygments` library to create a highlighted HTML</div><div class="line">    representation of the code snippet.</div><div class="line">    """</div><div class="line">    lexer = get_lexer_by_name(self.language)</div><div class="line">    linenos = self.linenos <span class="keyword">and</span> <span class="string">'table'</span> <span class="keyword">or</span> <span class="keyword">False</span></div><div class="line">    options = self.title <span class="keyword">and</span> &#123;<span class="string">'title'</span>: self.title&#125; <span class="keyword">or</span> &#123;&#125;</div><div class="line">    formatter = HtmlFormatter(style=self.style, linenos=linenos,</div><div class="line">                              full=<span class="keyword">True</span>, **options)</div><div class="line">    self.highlighted = highlight(self.code, lexer, formatter)</div><div class="line">    super(Snippet, self).save(*args, **kwargs)</div></pre></td></tr></table></figure><p>更新一些数据库。通常我们都是利用数据库迁移来完成这一操作，但是出于本教程的目的，我们直接删除数据库再创建吧。</p><figure class="highlight plain"><table><tr><td class="gutter"><pre><div class="line">1</div><div class="line">2</div><div class="line">3</div><div class="line">4</div></pre></td><td class="code"><pre><div class="line">rm -f db.sqlite3</div><div class="line">rm -r snippets/migrations</div><div class="line">python manage.py makemigrations snippets</div><div class="line">python manage.py migrate</div></pre></td></tr></table></figure><p>你可以需要创建一些不同的用户来测试我们的API。创建用户最快的方法就是使用<code>createsuperuser</code>命令。</p><figure class="highlight plain"><table><tr><td class="gutter"><pre><div class="line">1</div></pre></td><td class="code"><pre><div class="line">python manage.py createsuperuser</div></pre></td></tr></table></figure><h2 id="给用户模型添加端点"><a href="#给用户模型添加端点" class="headerlink" title="给用户模型添加端点"></a>给用户模型添加端点</h2><p>现在我们有了一些可以用的用户，我们最好给API添加用户的模型表示。创建一个序列器很简单。在<code>serializers.py</code>添加：</p><figure class="highlight python"><table><tr><td class="gutter"><pre><div class="line">1</div><div class="line">2</div><div class="line">3</div><div class="line">4</div><div class="line">5</div><div class="line">6</div><div class="line">7</div><div class="line">8</div></pre></td><td class="code"><pre><div class="line"><span class="keyword">from</span> django.contrib.auth.models <span class="keyword">import</span> User</div><div class="line"></div><div class="line"><span class="class"><span class="keyword">class</span> <span class="title">UserSerializer</span><span class="params">(serializers.ModelSerializer)</span>:</span></div><div class="line">    snippets = serializers.PrimaryKeyRelatedField(many=<span class="keyword">True</span>, queryset=Snippet.objects.all())</div><div class="line"></div><div class="line">    <span class="class"><span class="keyword">class</span> <span class="title">Meta</span>:</span></div><div class="line">        model = User</div><div class="line">        fields = (<span class="string">'id'</span>, <span class="string">'username'</span>, <span class="string">'snippets'</span>)</div></pre></td></tr></table></figure><p>因为<code>snippets</code>与用户模型是一个多对一的关系，使用<code>ModelSerializer</code>类时多的一方默认不生成该关系，所以我们需要为此添加一个字段。</p><p>修改<code>views.py</code>。我们想要用户模型表示的视图只能被浏览，所以我们使用通用类视图的<code>ListAPIView</code>和<code>RetrieveAPIView</code>。</p><figure class="highlight python"><table><tr><td class="gutter"><pre><div class="line">1</div><div class="line">2</div><div class="line">3</div><div class="line">4</div><div class="line">5</div><div class="line">6</div><div class="line">7</div><div class="line">8</div><div class="line">9</div><div class="line">10</div><div class="line">11</div></pre></td><td class="code"><pre><div class="line"><span class="keyword">from</span> django.contrib.auth.models <span class="keyword">import</span> User</div><div class="line"></div><div class="line"></div><div class="line"><span class="class"><span class="keyword">class</span> <span class="title">UserList</span><span class="params">(generics.ListAPIView)</span>:</span></div><div class="line">    queryset = User.objects.all()</div><div class="line">    serializer_class = UserSerializer</div><div class="line"></div><div class="line"></div><div class="line"><span class="class"><span class="keyword">class</span> <span class="title">UserDetail</span><span class="params">(generics.RetrieveAPIView)</span>:</span></div><div class="line">    queryset = User.objects.all()</div><div class="line">    serializer_class = UserSerializer</div></pre></td></tr></table></figure><p>导入<code>UserSerializer</code>类</p><figure class="highlight python"><table><tr><td class="gutter"><pre><div class="line">1</div></pre></td><td class="code"><pre><div class="line"><span class="keyword">from</span> snippets.serializers <span class="keyword">import</span> UserSerializer</div></pre></td></tr></table></figure><h2 id="关联片段和用户"><a href="#关联片段和用户" class="headerlink" title="关联片段和用户"></a>关联片段和用户</h2><p>现在，如果我们创建一个代码片段，还不能将创建者和片段关联起来。用户信息不是作为序列化的模型表示的一部分发送，而是作为传入请求的属性。</p><p>我们的处理方法是通过重写snippet视图的<code>.perform_create()</code>方法，该方法允许我们修改实例保存时的操作，和处理任何隐含在传入的请求或URL中的信息。</p><p>在<code>SnippetList</code>视图类中添加下面的方法：</p><figure class="highlight python"><table><tr><td class="gutter"><pre><div class="line">1</div><div class="line">2</div></pre></td><td class="code"><pre><div class="line"><span class="function"><span class="keyword">def</span> <span class="title">perform_create</span><span class="params">(self, serializer)</span>:</span></div><div class="line">    serializer.save(owner=self.request.user)</div></pre></td></tr></table></figure><p>现在通过请求的合法数据，向序列化器中的<code>.create()</code>方法传递额外的<code>owner</code>字段。</p><h2 id="给视图添加权限"><a href="#给视图添加权限" class="headerlink" title="给视图添加权限"></a>给视图添加权限</h2><h2 id="给Browsable-API-添加登陆功能"><a href="#给Browsable-API-添加登陆功能" class="headerlink" title="给Browsable API 添加登陆功能"></a>给Browsable API 添加登陆功能</h2><h2 id="对象级的权限"><a href="#对象级的权限" class="headerlink" title="对象级的权限"></a>对象级的权限</h2><h2 id="用API验证"><a href="#用API验证" class="headerlink" title="用API验证"></a>用API验证</h2><h2 id="总结"><a href="#总结" class="headerlink" title="总结"></a>总结</h2>]]></content>
    
    <summary type="html">
    
      &lt;p&gt;目前我们的API没有限制谁可以编辑和删除代码片段。我们想要一些更高级的行为来确保：&lt;br&gt;
    
    </summary>
    
    
      <category term="Django" scheme="http://yoursite.com/tags/Django/"/>
    
      <category term="Django REST framework" scheme="http://yoursite.com/tags/Django-REST-framework/"/>
    
      <category term="翻译" scheme="http://yoursite.com/tags/%E7%BF%BB%E8%AF%91/"/>
    
  </entry>
  
  <entry>
    <title>Django REST framework  教程3：基于类的视图</title>
    <link href="http://yoursite.com/2018/02/08/Django-REST-framework-%E6%95%99%E7%A8%8B3%EF%BC%9A%E5%9F%BA%E4%BA%8E%E7%B1%BB%E7%9A%84%E8%A7%86%E5%9B%BE/"/>
    <id>http://yoursite.com/2018/02/08/Django-REST-framework-教程3：基于类的视图/</id>
    <published>2018-02-08T09:38:46.000Z</published>
    <updated>2018-02-11T10:20:16.530Z</updated>
    
    <content type="html"><![CDATA[<p>我们也可以写类视图，而不是方法视图。我们将看到一个强大的模式，该模式允许我们复用公共功能，并且保持代码的DRY（Don’t repeat yourself）。<br><a id="more"></a></p><h2 id="使用基于类的视图重新我们的API"><a href="#使用基于类的视图重新我们的API" class="headerlink" title="使用基于类的视图重新我们的API"></a>使用基于类的视图重新我们的API</h2><p>使用类视图重构<code>views.py</code>。</p><figure class="highlight python"><table><tr><td class="gutter"><pre><div class="line">1</div><div class="line">2</div><div class="line">3</div><div class="line">4</div><div class="line">5</div><div class="line">6</div><div class="line">7</div><div class="line">8</div><div class="line">9</div><div class="line">10</div><div class="line">11</div><div class="line">12</div><div class="line">13</div><div class="line">14</div><div class="line">15</div><div class="line">16</div><div class="line">17</div><div class="line">18</div><div class="line">19</div><div class="line">20</div><div class="line">21</div><div class="line">22</div><div class="line">23</div></pre></td><td class="code"><pre><div class="line"><span class="keyword">from</span> snippets.models <span class="keyword">import</span> Snippet</div><div class="line"><span class="keyword">from</span> snippets.serializers <span class="keyword">import</span> SnippetSerializer</div><div class="line"><span class="keyword">from</span> django.http <span class="keyword">import</span> Http404</div><div class="line"><span class="keyword">from</span> rest_framework.views <span class="keyword">import</span> APIView</div><div class="line"><span class="keyword">from</span> rest_framework.response <span class="keyword">import</span> Response</div><div class="line"><span class="keyword">from</span> rest_framework <span class="keyword">import</span> status</div><div class="line"></div><div class="line"></div><div class="line"><span class="class"><span class="keyword">class</span> <span class="title">SnippetList</span><span class="params">(APIView)</span>:</span></div><div class="line">    <span class="string">"""</span></div><div class="line">    List all snippets, or create a new snippet.</div><div class="line">    """</div><div class="line">    <span class="function"><span class="keyword">def</span> <span class="title">get</span><span class="params">(self, request, format=None)</span>:</span></div><div class="line">        snippets = Snippet.objects.all()</div><div class="line">        serializer = SnippetSerializer(snippets, many=<span class="keyword">True</span>)</div><div class="line">        <span class="keyword">return</span> Response(serializer.data)</div><div class="line"></div><div class="line">    <span class="function"><span class="keyword">def</span> <span class="title">post</span><span class="params">(self, request, format=None)</span>:</span></div><div class="line">        serializer = SnippetSerializer(data=request.data)</div><div class="line">        <span class="keyword">if</span> serializer.is_valid():</div><div class="line">            serializer.save()</div><div class="line">            <span class="keyword">return</span> Response(serializer.data, status=status.HTTP_201_CREATED)</div><div class="line">        <span class="keyword">return</span> Response(serializer.errors, status=status.HTTP_400_BAD_REQUEST)</div></pre></td></tr></table></figure><p>目前看来还不错。感觉跟之前的例子很像，但是我们现在把两种不同的HTTP方法分成两个函数了。我们继续重构单个代码片段的视图。</p><figure class="highlight python"><table><tr><td class="gutter"><pre><div class="line">1</div><div class="line">2</div><div class="line">3</div><div class="line">4</div><div class="line">5</div><div class="line">6</div><div class="line">7</div><div class="line">8</div><div class="line">9</div><div class="line">10</div><div class="line">11</div><div class="line">12</div><div class="line">13</div><div class="line">14</div><div class="line">15</div><div class="line">16</div><div class="line">17</div><div class="line">18</div><div class="line">19</div><div class="line">20</div><div class="line">21</div><div class="line">22</div><div class="line">23</div><div class="line">24</div><div class="line">25</div><div class="line">26</div><div class="line">27</div></pre></td><td class="code"><pre><div class="line"><span class="class"><span class="keyword">class</span> <span class="title">SnippetDetail</span><span class="params">(APIView)</span>:</span></div><div class="line">    <span class="string">"""</span></div><div class="line">    Retrieve, update or delete a snippet instance.</div><div class="line">    """</div><div class="line">    <span class="function"><span class="keyword">def</span> <span class="title">get_object</span><span class="params">(self, pk)</span>:</span></div><div class="line">        <span class="keyword">try</span>:</div><div class="line">            <span class="keyword">return</span> Snippet.objects.get(pk=pk)</div><div class="line">        <span class="keyword">except</span> Snippet.DoesNotExist:</div><div class="line">            <span class="keyword">raise</span> Http404</div><div class="line"></div><div class="line">    <span class="function"><span class="keyword">def</span> <span class="title">get</span><span class="params">(self, request, pk, format=None)</span>:</span></div><div class="line">        snippet = self.get_object(pk)</div><div class="line">        serializer = SnippetSerializer(snippet)</div><div class="line">        <span class="keyword">return</span> Response(serializer.data)</div><div class="line"></div><div class="line">    <span class="function"><span class="keyword">def</span> <span class="title">put</span><span class="params">(self, request, pk, format=None)</span>:</span></div><div class="line">        snippet = self.get_object(pk)</div><div class="line">        serializer = SnippetSerializer(snippet, data=request.data)</div><div class="line">        <span class="keyword">if</span> serializer.is_valid():</div><div class="line">            serializer.save()</div><div class="line">            <span class="keyword">return</span> Response(serializer.data)</div><div class="line">        <span class="keyword">return</span> Response(serializer.errors, status=status.HTTP_400_BAD_REQUEST)</div><div class="line"></div><div class="line">    <span class="function"><span class="keyword">def</span> <span class="title">delete</span><span class="params">(self, request, pk, format=None)</span>:</span></div><div class="line">        snippet = self.get_object(pk)</div><div class="line">        snippet.delete()</div><div class="line">        <span class="keyword">return</span> Response(status=status.HTTP_204_NO_CONTENT)</div></pre></td></tr></table></figure><p>看起来跟之前差不多。<br>继续，我们还要重构我们的<code>snippets/urls.py</code>。</p><figure class="highlight python"><table><tr><td class="gutter"><pre><div class="line">1</div><div class="line">2</div><div class="line">3</div><div class="line">4</div><div class="line">5</div><div class="line">6</div><div class="line">7</div><div class="line">8</div><div class="line">9</div><div class="line">10</div></pre></td><td class="code"><pre><div class="line"><span class="keyword">from</span> django.conf.urls <span class="keyword">import</span> url</div><div class="line"><span class="keyword">from</span> rest_framework.urlpatterns <span class="keyword">import</span> format_suffix_patterns</div><div class="line"><span class="keyword">from</span> snippets <span class="keyword">import</span> views</div><div class="line"></div><div class="line">urlpatterns = [</div><div class="line">    path(<span class="string">'snippets/'</span>, views.SnippetList.as_view()),</div><div class="line">    path(<span class="string">'snippets/&lt;int:pk&gt;/'</span>, views.SnippetDetail.as_view()),</div><div class="line">]</div><div class="line"></div><div class="line">urlpatterns = format_suffix_patterns(urlpatterns)</div></pre></td></tr></table></figure><p>Okay，完成了。现在启动服务器，一切还是跟原来一样</p><h2 id="使用mixins"><a href="#使用mixins" class="headerlink" title="使用mixins"></a>使用mixins</h2><p>使用类视图最大的好处之一就是我们可以轻松地编写可复用的行为。</p><p>REST framework的mixin类实现了常用的创建/检索/更新/删除操作。</p><p>看一下如何使用mixin类编写视图。这儿还是<code>views.py</code>模块。</p><figure class="highlight python"><table><tr><td class="gutter"><pre><div class="line">1</div><div class="line">2</div><div class="line">3</div><div class="line">4</div><div class="line">5</div><div class="line">6</div><div class="line">7</div><div class="line">8</div><div class="line">9</div><div class="line">10</div><div class="line">11</div><div class="line">12</div><div class="line">13</div><div class="line">14</div><div class="line">15</div><div class="line">16</div></pre></td><td class="code"><pre><div class="line"><span class="keyword">from</span> snippets.models <span class="keyword">import</span> Snippet</div><div class="line"><span class="keyword">from</span> snippets.serializers <span class="keyword">import</span> SnippetSerializer</div><div class="line"><span class="keyword">from</span> rest_framework <span class="keyword">import</span> mixins</div><div class="line"><span class="keyword">from</span> rest_framework <span class="keyword">import</span> generics</div><div class="line"></div><div class="line"><span class="class"><span class="keyword">class</span> <span class="title">SnippetList</span><span class="params">(mixins.ListModelMixin,</span></span></div><div class="line">                  mixins.CreateModelMixin,</div><div class="line">                  generics.GenericAPIView):</div><div class="line">    queryset = Snippet.objects.all()</div><div class="line">    serializer_class = SnippetSerializer</div><div class="line"></div><div class="line">    <span class="function"><span class="keyword">def</span> <span class="title">get</span><span class="params">(self, request, *args, **kwargs)</span>:</span></div><div class="line">        <span class="keyword">return</span> self.list(request, *args, **kwargs)</div><div class="line"></div><div class="line">    <span class="function"><span class="keyword">def</span> <span class="title">post</span><span class="params">(self, request, *args, **kwargs)</span>:</span></div><div class="line">        <span class="keyword">return</span> self.create(request, *args, **kwargs)</div></pre></td></tr></table></figure><p>我们的视图继承了<code>GenericAPIView</code>和<code>ListModelMixin</code>，<code>CreateModelMixin</code>。</p><p>这些基类提供了核心的功能，mixin类还提供了<code>.list（）</code>和<code>.create（）</code>行为。我们将<code>get</code>和<code>post</code>方法绑定合适的行文上。多么简单！</p><figure class="highlight python"><table><tr><td class="gutter"><pre><div class="line">1</div><div class="line">2</div><div class="line">3</div><div class="line">4</div><div class="line">5</div><div class="line">6</div><div class="line">7</div><div class="line">8</div><div class="line">9</div><div class="line">10</div><div class="line">11</div><div class="line">12</div><div class="line">13</div><div class="line">14</div><div class="line">15</div></pre></td><td class="code"><pre><div class="line"><span class="class"><span class="keyword">class</span> <span class="title">SnippetDetail</span><span class="params">(mixins.RetrieveModelMixin,</span></span></div><div class="line">                    mixins.UpdateModelMixin,</div><div class="line">                    mixins.DestroyModelMixin,</div><div class="line">                    generics.GenericAPIView):</div><div class="line">    queryset = Snippet.objects.all()</div><div class="line">    serializer_class = SnippetSerializer</div><div class="line"></div><div class="line">    <span class="function"><span class="keyword">def</span> <span class="title">get</span><span class="params">(self, request, *args, **kwargs)</span>:</span></div><div class="line">        <span class="keyword">return</span> self.retrieve(request, *args, **kwargs)</div><div class="line"></div><div class="line">    <span class="function"><span class="keyword">def</span> <span class="title">put</span><span class="params">(self, request, *args, **kwargs)</span>:</span></div><div class="line">        <span class="keyword">return</span> self.update(request, *args, **kwargs)</div><div class="line"></div><div class="line">    <span class="function"><span class="keyword">def</span> <span class="title">delete</span><span class="params">(self, request, *args, **kwargs)</span>:</span></div><div class="line">        <span class="keyword">return</span> self.destroy(request, *args, **kwargs)</div></pre></td></tr></table></figure><p>我们再次使用<code>GenericAPIView</code>类来提供一些核心功能，并且添加mixins来提供<code>.retrieve（）</code>，<code>.update（）</code>和<code>。destroy（）</code>行为。</p><h2 id="使用通用的基于类的视图"><a href="#使用通用的基于类的视图" class="headerlink" title="使用通用的基于类的视图"></a>使用通用的基于类的视图</h2><p>使用mixin类可以使我们的视图代码更简洁，但我们可以更进一步，REST framework提供了一系列混合过的通用类，使得我们的<code>views.py</code>模块更加简洁！</p><figure class="highlight python"><table><tr><td class="gutter"><pre><div class="line">1</div><div class="line">2</div><div class="line">3</div><div class="line">4</div><div class="line">5</div><div class="line">6</div><div class="line">7</div><div class="line">8</div><div class="line">9</div><div class="line">10</div><div class="line">11</div><div class="line">12</div><div class="line">13</div></pre></td><td class="code"><pre><div class="line"><span class="keyword">from</span> snippets.models <span class="keyword">import</span> Snippet</div><div class="line"><span class="keyword">from</span> snippets.serializers <span class="keyword">import</span> SnippetSerializer</div><div class="line"><span class="keyword">from</span> rest_framework <span class="keyword">import</span> generics</div><div class="line"></div><div class="line"></div><div class="line"><span class="class"><span class="keyword">class</span> <span class="title">SnippetList</span><span class="params">(generics.ListCreateAPIView)</span>:</span></div><div class="line">    queryset = Snippet.objects.all()</div><div class="line">    serializer_class = SnippetSerializer</div><div class="line"></div><div class="line"></div><div class="line"><span class="class"><span class="keyword">class</span> <span class="title">SnippetDetail</span><span class="params">(generics.RetrieveUpdateDestroyAPIView)</span>:</span></div><div class="line">    queryset = Snippet.objects.all()</div><div class="line">    serializer_class = SnippetSerializer</div></pre></td></tr></table></figure><p>天啊！太简洁了！我们根本不用做什么！</p><p>接下来我们移步<a href="">教程4</a>，下一节将介绍如何处理API认证和权限的问题。</p>]]></content>
    
    <summary type="html">
    
      &lt;p&gt;我们也可以写类视图，而不是方法视图。我们将看到一个强大的模式，该模式允许我们复用公共功能，并且保持代码的DRY（Don’t repeat yourself）。&lt;br&gt;
    
    </summary>
    
    
      <category term="Django" scheme="http://yoursite.com/tags/Django/"/>
    
      <category term="Django REST framework" scheme="http://yoursite.com/tags/Django-REST-framework/"/>
    
      <category term="翻译" scheme="http://yoursite.com/tags/%E7%BF%BB%E8%AF%91/"/>
    
  </entry>
  
  <entry>
    <title>Django REST framework 教程2：请求和响应</title>
    <link href="http://yoursite.com/2018/02/08/Django-REST-framework-%E6%95%99%E7%A8%8B2%EF%BC%9A%E8%AF%B7%E6%B1%82%E5%92%8C%E5%93%8D%E5%BA%94/"/>
    <id>http://yoursite.com/2018/02/08/Django-REST-framework-教程2：请求和响应/</id>
    <published>2018-02-08T07:53:11.000Z</published>
    <updated>2018-02-10T14:04:07.764Z</updated>
    
    <content type="html"><![CDATA[<p>这一篇我们开始讲解RESTframework框架的核心内容。让我们介绍一些基本的构建模块。<br><a id="more"></a></p><h2 id="Request对象"><a href="#Request对象" class="headerlink" title="Request对象"></a>Request对象</h2><p>REST framework引入了<code>Request</code>对象，它继承自常规的<code>HttpRequest</code>，并提供更加灵活的请求解析。<code>Request</code>对象的核心功能是<code>request.data</code>参数，类似于<code>request.POST</code>。</p><figure class="highlight python"><table><tr><td class="gutter"><pre><div class="line">1</div><div class="line">2</div></pre></td><td class="code"><pre><div class="line">request.POST  <span class="comment"># 只能处理表单数据.  只能处理‘POST’请求</span></div><div class="line">request.data  <span class="comment"># 处理任何数据.  处理‘POST’,'PUT',‘PATCH’.</span></div></pre></td></tr></table></figure><h2 id="Response对象"><a href="#Response对象" class="headerlink" title="Response对象"></a>Response对象</h2><p>REST framework也引入了<code>Response</code>对象，使用内容协商来决定返回给客户端的数据类型。</p><figure class="highlight python"><table><tr><td class="gutter"><pre><div class="line">1</div></pre></td><td class="code"><pre><div class="line"><span class="keyword">return</span> Response(data)  <span class="comment"># 返回客户端请求的数据类型</span></div></pre></td></tr></table></figure><h2 id="状态码"><a href="#状态码" class="headerlink" title="状态码"></a>状态码</h2><p>在视图中使用纯数字的HTTP状态码可读性差，并且不容易发现错误。REST framework为每个状态码提供了明确的标识符，例如<code>status</code>模块中的<code>HTTP_400_BAD_REQUEST</code>。</p><h2 id="装饰API视图"><a href="#装饰API视图" class="headerlink" title="装饰API视图"></a>装饰API视图</h2><p>REST framework提供了两个可用于编写视图API的封装：</p><ol><li><code>@api_view</code>装饰视图函数</li><li><code>APIView</code>类可用作视图的基类</li></ol><p>这些封装提供了一些额外的功能，例如确保了你的视图接受到<code>Request</code>实例，执行内容协商，并且把内容添加到<code>Response</code>对象中。</p><p>也会适当得返回<code>405 Method Not Allowed</code>响应，以及处理<code>request.data</code>格式不正确的<code>ParseError</code>异常。</p><h2 id="把他们整合在一起"><a href="#把他们整合在一起" class="headerlink" title="把他们整合在一起"></a>把他们整合在一起</h2><p>让我们继续使用这些新组件写一些视图函数。</p><p>在<code>views.py</code>中我们不再需要<code>JSONResponse</code>类,所以删了它。完成后我们可以对我们的视图函数进行轻微的重构了。</p><figure class="highlight python"><table><tr><td class="gutter"><pre><div class="line">1</div><div class="line">2</div><div class="line">3</div><div class="line">4</div><div class="line">5</div><div class="line">6</div><div class="line">7</div><div class="line">8</div><div class="line">9</div><div class="line">10</div><div class="line">11</div><div class="line">12</div><div class="line">13</div><div class="line">14</div><div class="line">15</div><div class="line">16</div><div class="line">17</div><div class="line">18</div><div class="line">19</div><div class="line">20</div><div class="line">21</div><div class="line">22</div><div class="line">23</div></pre></td><td class="code"><pre><div class="line"><span class="keyword">from</span> rest_framework <span class="keyword">import</span> status</div><div class="line"><span class="keyword">from</span> rest_framework.decorators <span class="keyword">import</span> api_view</div><div class="line"><span class="keyword">from</span> rest_framework.response <span class="keyword">import</span> Response</div><div class="line"><span class="keyword">from</span> snippets.models <span class="keyword">import</span> Snippet</div><div class="line"><span class="keyword">from</span> snippets.serializers <span class="keyword">import</span> SnippetSerializer</div><div class="line"></div><div class="line"></div><div class="line"><span class="meta">@api_view(['GET', 'POST'])</span></div><div class="line"><span class="function"><span class="keyword">def</span> <span class="title">snippet_list</span><span class="params">(request)</span>:</span></div><div class="line">    <span class="string">"""</span></div><div class="line">    List all code snippets, or create a new snippet.</div><div class="line">    """</div><div class="line">    <span class="keyword">if</span> request.method == <span class="string">'GET'</span>:</div><div class="line">        snippets = Snippet.objects.all()</div><div class="line">        serializer = SnippetSerializer(snippets, many=<span class="keyword">True</span>)</div><div class="line">        <span class="keyword">return</span> Response(serializer.data)</div><div class="line"></div><div class="line">    <span class="keyword">elif</span> request.method == <span class="string">'POST'</span>:</div><div class="line">        serializer = SnippetSerializer(data=request.data)</div><div class="line">        <span class="keyword">if</span> serializer.is_valid():</div><div class="line">            serializer.save()</div><div class="line">            <span class="keyword">return</span> Response(serializer.data, status=status.HTTP_201_CREATED)</div><div class="line">        <span class="keyword">return</span> Response(serializer.errors, status=status.HTTP_400_BAD_REQUEST)</div></pre></td></tr></table></figure><p>我们改进了之前的例子。变得更加简洁，代码风格也跟Forms API很像，同时使用了命名的状态码这使得响应内容更加明确。</p><p>单个页面的视图函数。</p><figure class="highlight python"><table><tr><td class="gutter"><pre><div class="line">1</div><div class="line">2</div><div class="line">3</div><div class="line">4</div><div class="line">5</div><div class="line">6</div><div class="line">7</div><div class="line">8</div><div class="line">9</div><div class="line">10</div><div class="line">11</div><div class="line">12</div><div class="line">13</div><div class="line">14</div><div class="line">15</div><div class="line">16</div><div class="line">17</div><div class="line">18</div><div class="line">19</div><div class="line">20</div><div class="line">21</div><div class="line">22</div><div class="line">23</div><div class="line">24</div></pre></td><td class="code"><pre><div class="line"><span class="meta">@api_view(['GET', 'PUT', 'DELETE'])</span></div><div class="line"><span class="function"><span class="keyword">def</span> <span class="title">snippet_detail</span><span class="params">(request, pk)</span>:</span></div><div class="line">    <span class="string">"""</span></div><div class="line">    Retrieve, update or delete a code snippet.</div><div class="line">    """</div><div class="line">    <span class="keyword">try</span>:</div><div class="line">        snippet = Snippet.objects.get(pk=pk)</div><div class="line">    <span class="keyword">except</span> Snippet.DoesNotExist:</div><div class="line">        <span class="keyword">return</span> Response(status=status.HTTP_404_NOT_FOUND)</div><div class="line"></div><div class="line">    <span class="keyword">if</span> request.method == <span class="string">'GET'</span>:</div><div class="line">        serializer = SnippetSerializer(snippet)</div><div class="line">        <span class="keyword">return</span> Response(serializer.data)</div><div class="line"></div><div class="line">    <span class="keyword">elif</span> request.method == <span class="string">'PUT'</span>:</div><div class="line">        serializer = SnippetSerializer(snippet, data=request.data)</div><div class="line">        <span class="keyword">if</span> serializer.is_valid():</div><div class="line">            serializer.save()</div><div class="line">            <span class="keyword">return</span> Response(serializer.data)</div><div class="line">        <span class="keyword">return</span> Response(serializer.errors, status=status.HTTP_400_BAD_REQUEST)</div><div class="line"></div><div class="line">    <span class="keyword">elif</span> request.method == <span class="string">'DELETE'</span>:</div><div class="line">        snippet.delete()</div><div class="line">        <span class="keyword">return</span> Response(status=status.HTTP_204_NO_CONTENT)</div></pre></td></tr></table></figure><p>应该感觉非常熟悉-这个普通的Django视图没什么不同。</p><p>注意到，我们没有明确请求或响应的数据类型。<code>request.data</code>可以处理传进来的<code>json</code>请求，也可以处理其他数据格式。同样，我们返回包含数据的响应时，REST framework会将数据渲染成恰当的数据格式。</p><h2 id="给URLs添加可选的格式后缀"><a href="#给URLs添加可选的格式后缀" class="headerlink" title="给URLs添加可选的格式后缀"></a>给URLs添加可选的格式后缀</h2><p>利用上面的特性，我们的响应可以返回多种数据类型，让我们为API端点添加格式后缀的支持。意味着我们的API可以出来这种URLs <a href="http://example.com/api/items/4.json" target="_blank" rel="external">http://example.com/api/items/4.json</a>.</p><p>给所有的视图函数添加<code>format</code>关键字参数，就像</p><figure class="highlight python"><table><tr><td class="gutter"><pre><div class="line">1</div></pre></td><td class="code"><pre><div class="line"><span class="function"><span class="keyword">def</span> <span class="title">snippet_list</span><span class="params">(request, format=None)</span>:</span></div></pre></td></tr></table></figure><p>和</p><figure class="highlight python"><table><tr><td class="gutter"><pre><div class="line">1</div></pre></td><td class="code"><pre><div class="line"><span class="function"><span class="keyword">def</span> <span class="title">snippet_detail</span><span class="params">(request, pk, format=None)</span>:</span></div></pre></td></tr></table></figure><p>现在更新一下<code>snippets/urls.py</code>文件，将现有的URLs添加到一组<code>format_suffix_patterns</code>中。</p><figure class="highlight python"><table><tr><td class="gutter"><pre><div class="line">1</div><div class="line">2</div><div class="line">3</div><div class="line">4</div><div class="line">5</div><div class="line">6</div><div class="line">7</div><div class="line">8</div><div class="line">9</div><div class="line">10</div></pre></td><td class="code"><pre><div class="line"><span class="keyword">from</span> django.urls <span class="keyword">import</span> path</div><div class="line"><span class="keyword">from</span> snippets <span class="keyword">import</span> views</div><div class="line"><span class="keyword">from</span> rest_framework.urlpatterns <span class="keyword">import</span> format_suffix_patterns</div><div class="line"></div><div class="line">urlpatterns = [</div><div class="line">    path(<span class="string">'snippets/'</span>, views.snippet_list),</div><div class="line">    path(<span class="string">'snippets/&lt;int:pk&gt;/'</span>, views.snippet_detail),</div><div class="line">]</div><div class="line"></div><div class="line">urlpatterns = format_suffix_patterns(urlpatterns)</div></pre></td></tr></table></figure><p>它提供了一种简单的引用方式，因此我们不需要再添加额外的url模式。</p><h2 id="看起来怎么样？"><a href="#看起来怎么样？" class="headerlink" title="看起来怎么样？"></a>看起来怎么样？</h2><p>继续在命令行中测试我们的API。一切好像没什么变化，除了我们发生无效的请求时多了一些很好的错误处理。</p><p>我们可以像之前一样获得所有代码片段。</p><figure class="highlight"><table><tr><td class="gutter"><pre><div class="line">1</div><div class="line">2</div><div class="line">3</div><div class="line">4</div><div class="line">5</div><div class="line">6</div><div class="line">7</div><div class="line">8</div><div class="line">9</div><div class="line">10</div><div class="line">11</div><div class="line">12</div><div class="line">13</div><div class="line">14</div><div class="line">15</div><div class="line">16</div><div class="line">17</div><div class="line">18</div><div class="line">19</div><div class="line">20</div><div class="line">21</div><div class="line">22</div></pre></td><td class="code"><pre><div class="line">http http://127.0.0.1:8000/snippets/</div><div class="line"></div><div class="line">HTTP/1.1 200 OK</div><div class="line">...</div><div class="line">[</div><div class="line">  &#123;</div><div class="line">    "id": 1,</div><div class="line">    "title": "",</div><div class="line">    "code": "foo = \"bar\"\n",</div><div class="line">    "linenos": false,</div><div class="line">    "language": "python",</div><div class="line">    "style": "friendly"</div><div class="line">  &#125;,</div><div class="line">  &#123;</div><div class="line">    "id": 2,</div><div class="line">    "title": "",</div><div class="line">    "code": "print \"hello, world\"\n",</div><div class="line">    "linenos": false,</div><div class="line">    "language": "python",</div><div class="line">    "style": "friendly"</div><div class="line">  &#125;</div><div class="line">]</div></pre></td></tr></table></figure><p>使用<code>Accept</code>头部字段，我们可以控制响应的格式：</p><figure class="highlight plain"><table><tr><td class="gutter"><pre><div class="line">1</div><div class="line">2</div></pre></td><td class="code"><pre><div class="line">http http://127.0.0.1:8000/snippets/ Accept:application/json  # 请求JSON数据</div><div class="line">http http://127.0.0.1:8000/snippets/ Accept:text/html         # 请求HTML数据</div></pre></td></tr></table></figure><p>或者添加格式后缀：</p><figure class="highlight plain"><table><tr><td class="gutter"><pre><div class="line">1</div><div class="line">2</div></pre></td><td class="code"><pre><div class="line">http http://127.0.0.1:8000/snippets.json  # JSON 后缀</div><div class="line">http http://127.0.0.1:8000/snippets.api   # Browsable API suffix</div></pre></td></tr></table></figure><p>同样，也可以使用<code>Content-Type</code>头部字段设置我们所发送的数据的数据格式。</p><figure class="highlight"><table><tr><td class="gutter"><pre><div class="line">1</div><div class="line">2</div><div class="line">3</div><div class="line">4</div><div class="line">5</div><div class="line">6</div><div class="line">7</div><div class="line">8</div><div class="line">9</div><div class="line">10</div><div class="line">11</div><div class="line">12</div><div class="line">13</div><div class="line">14</div><div class="line">15</div><div class="line">16</div><div class="line">17</div><div class="line">18</div><div class="line">19</div><div class="line">20</div><div class="line">21</div><div class="line">22</div><div class="line">23</div></pre></td><td class="code"><pre><div class="line"># POST 表单数据</div><div class="line">http --form POST http://127.0.0.1:8000/snippets/ code="print 123"</div><div class="line"></div><div class="line">&#123;</div><div class="line">  "id": 3,</div><div class="line">  "title": "",</div><div class="line">  "code": "print 123",</div><div class="line">  "linenos": false,</div><div class="line">  "language": "python",</div><div class="line">  "style": "friendly"</div><div class="line">&#125;</div><div class="line"></div><div class="line"># POST JSON数据</div><div class="line">http --json POST http://127.0.0.1:8000/snippets/ code="print 456"</div><div class="line"></div><div class="line">&#123;</div><div class="line">    "id": 4,</div><div class="line">    "title": "",</div><div class="line">    "code": "print 456",</div><div class="line">    "linenos": false,</div><div class="line">    "language": "python",</div><div class="line">    "style": "friendly"</div><div class="line">&#125;</div></pre></td></tr></table></figure><p>如果你在上面的<code>http</code>命令前添加<code>--debug</code>，你还能在请求头部看到请求类型。</p><p>现在打开浏览器，访问 <a href="http://127.0.0.1:8000/snippets/" target="_blank" rel="external">http://127.0.0.1:8000/snippets/</a>.</p><h3 id="Browsability"><a href="#Browsability" class="headerlink" title="Browsability"></a>Browsability</h3><p>API的响应类型取决于客户端的请求，但是默认情况下，当浏览器请求一个资源时会返回一个HTML格式的响应。</p><p>拥有一个可浏览的API是一个巨大的可用性胜利，并且使开发和使用API更容易。它也大大降低了想要检查和使用您的API的其他开发人员的障碍</p><p>想要了解更多可查阅<a href="http://www.django-rest-framework.org/topics/browsable-api/" target="_blank" rel="external">browsable api</a></p><h2 id="下一步是什么？"><a href="#下一步是什么？" class="headerlink" title="下一步是什么？"></a>下一步是什么？</h2><p>在<a href="">教程3</a>，我们将会使用基于类的视图，并且学习如何通过视图减少大量的代码。</p>]]></content>
    
    <summary type="html">
    
      &lt;p&gt;这一篇我们开始讲解RESTframework框架的核心内容。让我们介绍一些基本的构建模块。&lt;br&gt;
    
    </summary>
    
    
      <category term="Django" scheme="http://yoursite.com/tags/Django/"/>
    
      <category term="Django REST framework" scheme="http://yoursite.com/tags/Django-REST-framework/"/>
    
      <category term="翻译" scheme="http://yoursite.com/tags/%E7%BF%BB%E8%AF%91/"/>
    
  </entry>
  
  <entry>
    <title>Django REST framework 教程1：序列化</title>
    <link href="http://yoursite.com/2018/02/07/Django-RESTful-framework%E6%95%99%E7%A8%8B1%EF%BC%9A%E5%BA%8F%E5%88%97%E5%8C%96/"/>
    <id>http://yoursite.com/2018/02/07/Django-RESTful-framework教程1：序列化/</id>
    <published>2018-02-07T14:10:46.000Z</published>
    <updated>2018-02-17T09:42:21.187Z</updated>
    
    <content type="html"><![CDATA[<h2 id="介绍"><a href="#介绍" class="headerlink" title="介绍"></a>介绍</h2><p>这个教程将创建一套简单的代码高亮的pastebin的Web API。一路上我们会介绍许多构建<code>REST frmaework</code>的组件，并且让你有一个全面的认识，这些组件是如何组建在一起的。<br><a id="more"></a><br>这个教程相当’深奥’，在开始学习之前你大概需要准备一些饼干和一杯你最爱的啤酒。你如果只是想快速了解，你可以查看之前的<a href="http://zojian.cn/2018/02/06/Django-RESTful-framework%E5%BF%AB%E9%80%9F%E5%85%A5%E9%97%A8/" target="_blank" rel="external">快速入门</a>文档。</p><blockquote><p>注意：教程中的代码可以访问<a href="https://github.com/encode/rest-framework-tutorial" target="_blank" rel="external">github地址</a>，完整的代码：<a href="https://restframework.herokuapp.com/" target="_blank" rel="external">这里</a></p></blockquote><h2 id="设置新环境"><a href="#设置新环境" class="headerlink" title="设置新环境"></a>设置新环境</h2><p>在我们开始之前，我们会使用<code>virtualenv</code>创建一个新的虚拟环境。这可以很好的将我们的项目与其他项目隔离开。</p><figure class="highlight plain"><table><tr><td class="gutter"><pre><div class="line">1</div><div class="line">2</div></pre></td><td class="code"><pre><div class="line">virtualenv env</div><div class="line">source env/bin/activate</div></pre></td></tr></table></figure><p>现在我们已经进入虚拟环境，我们可以安装一些依赖包了。</p><figure class="highlight plain"><table><tr><td class="gutter"><pre><div class="line">1</div><div class="line">2</div><div class="line">3</div></pre></td><td class="code"><pre><div class="line">pip install django</div><div class="line">pip install djangorestframework</div><div class="line">pip install pygments  # 我们将使用这个使代码高亮</div></pre></td></tr></table></figure><blockquote><p>注意：退出虚拟环境可以输入<code>deactivate</code>。更多信息，请看<a href="http://www.virtualenv.org/en/latest/index.html" target="_blank" rel="external">virtualenv文档</a></p></blockquote><h2 id="准备开始"><a href="#准备开始" class="headerlink" title="准备开始"></a>准备开始</h2><p>我们已经准备开始敲代码了。开始前，让我们先创建一个新的项目。</p><figure class="highlight plain"><table><tr><td class="gutter"><pre><div class="line">1</div><div class="line">2</div><div class="line">3</div></pre></td><td class="code"><pre><div class="line">cd ~</div><div class="line">django-admin.py startproject tutorial</div><div class="line">cd tutorial</div></pre></td></tr></table></figure><p>一旦完成，我们可以创建一个app，我们将使用它来创建一套简单的Web API。</p><figure class="highlight plain"><table><tr><td class="gutter"><pre><div class="line">1</div></pre></td><td class="code"><pre><div class="line">python manage.py startapp snippets</div></pre></td></tr></table></figure><p>我们需要将<code>snippets</code>app和<code>rest_framework</code>app添加到<code>INSTALLED_APPS</code>中。编辑<code>tutorial/settings.py</code>文件：</p><figure class="highlight python"><table><tr><td class="gutter"><pre><div class="line">1</div><div class="line">2</div><div class="line">3</div><div class="line">4</div><div class="line">5</div></pre></td><td class="code"><pre><div class="line">INSTALLED_APPS = (</div><div class="line">    ...</div><div class="line">    <span class="string">'rest_framework'</span>,</div><div class="line">    <span class="string">'snippets.apps.SnippetsConfig'</span>,</div><div class="line">)</div></pre></td></tr></table></figure><p>Okay,我们已经准备好了~</p><h2 id="创建一个模型"><a href="#创建一个模型" class="headerlink" title="创建一个模型"></a>创建一个模型</h2><p>出于本教程的目的，我们首先创建一个简单的<code>Snippet</code>模块，用于存储代码片段。编辑<code>snippets/models.py</code>文件：</p><figure class="highlight python"><table><tr><td class="gutter"><pre><div class="line">1</div><div class="line">2</div><div class="line">3</div><div class="line">4</div><div class="line">5</div><div class="line">6</div><div class="line">7</div><div class="line">8</div><div class="line">9</div><div class="line">10</div><div class="line">11</div><div class="line">12</div><div class="line">13</div><div class="line">14</div><div class="line">15</div><div class="line">16</div><div class="line">17</div><div class="line">18</div><div class="line">19</div></pre></td><td class="code"><pre><div class="line"><span class="keyword">from</span> django.db <span class="keyword">import</span> models</div><div class="line"><span class="keyword">from</span> pygments.lexers <span class="keyword">import</span> get_all_lexers</div><div class="line"><span class="keyword">from</span> pygments.styles <span class="keyword">import</span> get_all_styles</div><div class="line"></div><div class="line">LEXERS = [item <span class="keyword">for</span> item <span class="keyword">in</span> get_all_lexers() <span class="keyword">if</span> item[<span class="number">1</span>]]</div><div class="line">LANGUAGE_CHOICES = sorted([(item[<span class="number">1</span>][<span class="number">0</span>], item[<span class="number">0</span>]) <span class="keyword">for</span> item <span class="keyword">in</span> LEXERS])</div><div class="line">STYLE_CHOICES = sorted((item, item) <span class="keyword">for</span> item <span class="keyword">in</span> get_all_styles())</div><div class="line"></div><div class="line"></div><div class="line"><span class="class"><span class="keyword">class</span> <span class="title">Snippet</span><span class="params">(models.Model)</span>:</span></div><div class="line">    created = models.DateTimeField(auto_now_add=<span class="keyword">True</span>)</div><div class="line">    title = models.CharField(max_length=<span class="number">100</span>, blank=<span class="keyword">True</span>, default=<span class="string">''</span>)</div><div class="line">    code = models.TextField()</div><div class="line">    linenos = models.BooleanField(default=<span class="keyword">False</span>)</div><div class="line">    language = models.CharField(choices=LANGUAGE_CHOICES, default=<span class="string">'python'</span>, max_length=<span class="number">100</span>)</div><div class="line">    style = models.CharField(choices=STYLE_CHOICES, default=<span class="string">'friendly'</span>, max_length=<span class="number">100</span>)</div><div class="line"></div><div class="line">    <span class="class"><span class="keyword">class</span> <span class="title">Meta</span>:</span></div><div class="line">        ordering = (<span class="string">'created'</span>,)</div></pre></td></tr></table></figure><p>同步数据库</p><figure class="highlight plain"><table><tr><td class="gutter"><pre><div class="line">1</div><div class="line">2</div></pre></td><td class="code"><pre><div class="line">python manage.py makemigrations snippets</div><div class="line">python manage.py migrate</div></pre></td></tr></table></figure><h2 id="创建一个序列化器"><a href="#创建一个序列化器" class="headerlink" title="创建一个序列化器"></a>创建一个序列化器</h2><p>使用WebS API的第一件事就是提供一种将snippet实例序列化和反序列化成其他数据格式（如json）的方法。我们可以声明<code>serializers（序列化器）</code>来实现，这和Django的forms很像。在<code>snippets</code>的目录下创建一个<code>serializers.py</code>文件并添加如下代码：</p><figure class="highlight python"><table><tr><td class="gutter"><pre><div class="line">1</div><div class="line">2</div><div class="line">3</div><div class="line">4</div><div class="line">5</div><div class="line">6</div><div class="line">7</div><div class="line">8</div><div class="line">9</div><div class="line">10</div><div class="line">11</div><div class="line">12</div><div class="line">13</div><div class="line">14</div><div class="line">15</div><div class="line">16</div><div class="line">17</div><div class="line">18</div><div class="line">19</div><div class="line">20</div><div class="line">21</div><div class="line">22</div><div class="line">23</div><div class="line">24</div><div class="line">25</div><div class="line">26</div><div class="line">27</div><div class="line">28</div><div class="line">29</div></pre></td><td class="code"><pre><div class="line"><span class="keyword">from</span> rest_framework <span class="keyword">import</span> serializers</div><div class="line"><span class="keyword">from</span> snippets.models <span class="keyword">import</span> Snippet, LANGUAGE_CHOICES, STYLE_CHOICES</div><div class="line"></div><div class="line"></div><div class="line"><span class="class"><span class="keyword">class</span> <span class="title">SnippetSerializer</span><span class="params">(serializers.Serializer)</span>:</span></div><div class="line">    id = serializers.IntegerField(read_only=<span class="keyword">True</span>)</div><div class="line">    title = serializers.CharField(required=<span class="keyword">False</span>, allow_blank=<span class="keyword">True</span>, max_length=<span class="number">100</span>)</div><div class="line">    code = serializers.CharField(style=&#123;<span class="string">'base_template'</span>: <span class="string">'textarea.html'</span>&#125;)</div><div class="line">    linenos = serializers.BooleanField(required=<span class="keyword">False</span>)</div><div class="line">    language = serializers.ChoiceField(choices=LANGUAGE_CHOICES, default=<span class="string">'python'</span>)</div><div class="line">    style = serializers.ChoiceField(choices=STYLE_CHOICES, default=<span class="string">'friendly'</span>)</div><div class="line"></div><div class="line">    <span class="function"><span class="keyword">def</span> <span class="title">create</span><span class="params">(self, validated_data)</span>:</span></div><div class="line">        <span class="string">"""</span></div><div class="line">        创建并返回一个Snippet实例</div><div class="line">        """</div><div class="line">        <span class="keyword">return</span> Snippet.objects.create(**validated_data)</div><div class="line"></div><div class="line">    <span class="function"><span class="keyword">def</span> <span class="title">update</span><span class="params">(self, instance, validated_data)</span>:</span></div><div class="line">        <span class="string">"""</span></div><div class="line">        更新并返回一个已经存在Snippet实例</div><div class="line">        """</div><div class="line">        instance.title = validated_data.get(<span class="string">'title'</span>, instance.title)</div><div class="line">        instance.code = validated_data.get(<span class="string">'code'</span>, instance.code)</div><div class="line">        instance.linenos = validated_data.get(<span class="string">'linenos'</span>, instance.linenos)</div><div class="line">        instance.language = validated_data.get(<span class="string">'language'</span>, instance.language)</div><div class="line">        instance.style = validated_data.get(<span class="string">'style'</span>, instance.style)</div><div class="line">        instance.save()</div><div class="line">        <span class="keyword">return</span> instance</div></pre></td></tr></table></figure><p>序列化器的第一部分是定义序列化/反序列化的字段。<code>create（）</code>和<code>update（）</code>方法定义了当调用<code>serializer.save（）</code>是一个实例是如何被创建或更新的。</p><p>序列化器类(serializer)很像Django的<code>Form</code>，同时在各个字段中也包含了类似的验证标志，如<code>required</code>，<code>max_length</code>和<code>default</code>。</p><p>在某些情况下，字段标志也可以控制序列化后如何显示，例如渲染成HTML。上面的<code>{&#39;base_template&#39;: &#39;textarea.html&#39;}</code>标志等同于在Django<code>Form</code>类中使用<code>widget=widgets.Textarea</code>。这对于控制如何显示browsable API特别有用，正如我们将在教程后面看到的。</p><p>事实上，我们可以通过使用<code>ModelSerializer</code>类节省开发时间，稍后我们会看到，但是现在我们仍把注意力放在序列化器的明确定义上。</p><h2 id="使用序列化器"><a href="#使用序列化器" class="headerlink" title="使用序列化器"></a>使用序列化器</h2><p>我们先熟悉一下我们的新序列化器如何使用。进入Django shell</p><figure class="highlight plain"><table><tr><td class="gutter"><pre><div class="line">1</div></pre></td><td class="code"><pre><div class="line">python manage.py shell</div></pre></td></tr></table></figure><p>Okay,导入一些必要的东西，让我们创建两个代码片段<br><figure class="highlight python"><table><tr><td class="gutter"><pre><div class="line">1</div><div class="line">2</div><div class="line">3</div><div class="line">4</div><div class="line">5</div><div class="line">6</div><div class="line">7</div><div class="line">8</div><div class="line">9</div><div class="line">10</div></pre></td><td class="code"><pre><div class="line"><span class="keyword">from</span> snippets.models <span class="keyword">import</span> Snippet</div><div class="line"><span class="keyword">from</span> snippets.serializers <span class="keyword">import</span> SnippetSerializer</div><div class="line"><span class="keyword">from</span> rest_framework.renderers <span class="keyword">import</span> JSONRenderer</div><div class="line"><span class="keyword">from</span> rest_framework.parsers <span class="keyword">import</span> JSONParser</div><div class="line"></div><div class="line">snippet = Snippet(code=<span class="string">'foo = "bar"\n'</span>)</div><div class="line">snippet.save()</div><div class="line"></div><div class="line">snippet = Snippet(code=<span class="string">'print "hello, world"\n'</span>)</div><div class="line">snippet.save()</div></pre></td></tr></table></figure></p><p>我们现在已经有两个可用的代码片端实例，将其中一个序列化试试看。</p><figure class="highlight python"><table><tr><td class="gutter"><pre><div class="line">1</div><div class="line">2</div><div class="line">3</div></pre></td><td class="code"><pre><div class="line">serializer = SnippetSerializer(snippet)</div><div class="line">serializer.data</div><div class="line"><span class="comment"># &#123;'id': 2, 'title': u'', 'code': u'print "hello, world"\n', 'linenos': False, 'language': u'python', 'style': u'friendly'&#125;</span></div></pre></td></tr></table></figure><p>我们已经将模型实例转换成Python原生的数据类型。为了完成序列化工作，我们将数据渲染成json。</p><figure class="highlight python"><table><tr><td class="gutter"><pre><div class="line">1</div><div class="line">2</div><div class="line">3</div></pre></td><td class="code"><pre><div class="line">content = JSONRenderer().render(serializer.data)</div><div class="line">content</div><div class="line"><span class="comment"># '&#123;"id": 2, "title": "", "code": "print \\"hello, world\\"\\n", "linenos": false, "language": "python", "style": "friendly"&#125;'</span></div></pre></td></tr></table></figure><p>反序列化也一样。我们将流解析成Python原生类型…</p><figure class="highlight python"><table><tr><td class="gutter"><pre><div class="line">1</div><div class="line">2</div><div class="line">3</div><div class="line">4</div></pre></td><td class="code"><pre><div class="line"><span class="keyword">from</span> django.utils.six <span class="keyword">import</span> BytesIO</div><div class="line"></div><div class="line">stream = BytesIO(content)</div><div class="line">data = JSONParser().parse(stream)</div></pre></td></tr></table></figure><p>…然后我们把原生类型还原成一个完整的对象实例</p><figure class="highlight python"><table><tr><td class="gutter"><pre><div class="line">1</div><div class="line">2</div><div class="line">3</div><div class="line">4</div><div class="line">5</div><div class="line">6</div><div class="line">7</div></pre></td><td class="code"><pre><div class="line">serializer = SnippetSerializer(data=data)</div><div class="line">serializer.is_valid()</div><div class="line"><span class="comment"># True</span></div><div class="line">serializer.validated_data</div><div class="line"><span class="comment"># OrderedDict([('title', ''), ('code', 'print "hello, world"\n'), ('linenos', False), ('language', 'python'), ('style', 'friendly')])</span></div><div class="line">serializer.save()</div><div class="line"><span class="comment"># &lt;Snippet: Snippet object&gt;</span></div></pre></td></tr></table></figure><p>注意表单类型的API是如何工作的。当我们使用序列化器写视图函数时，相似之处会变得更加明显。</p><p>我们也可以对一个querysets进行序列化。只需在序列化器的参数中添加一个<code>many=True</code>的标志。</p><figure class="highlight python"><table><tr><td class="gutter"><pre><div class="line">1</div><div class="line">2</div><div class="line">3</div></pre></td><td class="code"><pre><div class="line">serializer = SnippetSerializer(Snippet.objects.all(), many=<span class="keyword">True</span>)</div><div class="line">serializer.data</div><div class="line"><span class="comment"># [OrderedDict([('id', 1), ('title', u''), ('code', u'foo = "bar"\n'), ('linenos', False), ('language', 'python'), ('style', 'friendly')]), OrderedDict([('id', 2), ('title', u''), ('code', u'print "hello, world"\n'), ('linenos', False), ('language', 'python'), ('style', 'friendly')]), OrderedDict([('id', 3), ('title', u''), ('code', u'print "hello, world"'), ('linenos', False), ('language', 'python'), ('style', 'friendly')])]</span></div></pre></td></tr></table></figure><h2 id="使用ModelSerializers"><a href="#使用ModelSerializers" class="headerlink" title="使用ModelSerializers"></a>使用ModelSerializers</h2><p>我们的<code>SnippetSerializer</code>类太臃肿了，要是能再简洁一点就更好了。</p><p>Django提供了<code>Form</code>类<code>ModelForm</code>类，同样的，RESTframework也有<code>Serializer</code>和<code>ModelSerializer</code>。</p><p>现在让我们用<code>ModelSerializer</code>重构我们序列化器吧。再次打开<code>snippets/serializer.py</code>，将<code>SnippetSetializer</code>类替换为一下代码。</p><figure class="highlight python"><table><tr><td class="gutter"><pre><div class="line">1</div><div class="line">2</div><div class="line">3</div><div class="line">4</div></pre></td><td class="code"><pre><div class="line"><span class="class"><span class="keyword">class</span> <span class="title">SnippetSerializer</span><span class="params">(serializers.ModelSerializer)</span>:</span></div><div class="line">    <span class="class"><span class="keyword">class</span> <span class="title">Meta</span>:</span></div><div class="line">        model = Snippet</div><div class="line">        fields = (<span class="string">'id'</span>, <span class="string">'title'</span>, <span class="string">'code'</span>, <span class="string">'linenos'</span>, <span class="string">'language'</span>, <span class="string">'style'</span>)</div></pre></td></tr></table></figure><p>还有一个不错的特性就是你可以通过打印序列化器实例来查看所有字段信息。打开Django shell，输入一下命令：</p><figure class="highlight python"><table><tr><td class="gutter"><pre><div class="line">1</div><div class="line">2</div><div class="line">3</div><div class="line">4</div><div class="line">5</div><div class="line">6</div><div class="line">7</div><div class="line">8</div><div class="line">9</div><div class="line">10</div></pre></td><td class="code"><pre><div class="line"><span class="keyword">from</span> snippets.serializers <span class="keyword">import</span> SnippetSerializer</div><div class="line">serializer = SnippetSerializer()</div><div class="line">print(repr(serializer))</div><div class="line"><span class="comment"># SnippetSerializer():</span></div><div class="line"><span class="comment">#    id = IntegerField(label='ID', read_only=True)</span></div><div class="line"><span class="comment">#    title = CharField(allow_blank=True, max_length=100, required=False)</span></div><div class="line"><span class="comment">#    code = CharField(style=&#123;'base_template': 'textarea.html'&#125;)</span></div><div class="line"><span class="comment">#    linenos = BooleanField(required=False)</span></div><div class="line"><span class="comment">#    language = ChoiceField(choices=[('Clipper', 'FoxPro'), ('Cucumber', 'Gherkin'), ('RobotFramework', 'RobotFramework'), ('abap', 'ABAP'), ('ada', 'Ada')...</span></div><div class="line"><span class="comment">#    style = ChoiceField(choices=[('autumn', 'autumn'), ('borland', 'borland'), ('bw', 'bw'), ('colorful', 'colorful')...</span></div></pre></td></tr></table></figure><p>记住，<code>ModelSerializer</code>类并没有做什么特别的事情，它只是一个创建序列化器的捷径：</p><ul><li>自动判定字段类型</li><li>简单实现<code>create（）</code>和<code>update（）</code>方法</li></ul><h2 id="使用序列化器编写常规的Django视图"><a href="#使用序列化器编写常规的Django视图" class="headerlink" title="使用序列化器编写常规的Django视图"></a>使用序列化器编写常规的Django视图</h2><p>目前我们不会使用任何RESTframework的其他特性，我们只是编写Djang常规的视图函数。<br>编辑<code>snippets/views.py</code>文件，并添加以下代码。</p><figure class="highlight python"><table><tr><td class="gutter"><pre><div class="line">1</div><div class="line">2</div><div class="line">3</div><div class="line">4</div><div class="line">5</div><div class="line">6</div></pre></td><td class="code"><pre><div class="line"><span class="keyword">from</span> django.http <span class="keyword">import</span> HttpResponse, JsonResponse</div><div class="line"><span class="keyword">from</span> django.views.decorators.csrf <span class="keyword">import</span> csrf_exempt</div><div class="line"><span class="keyword">from</span> rest_framework.renderers <span class="keyword">import</span> JSONRenderer</div><div class="line"><span class="keyword">from</span> rest_framework.parsers <span class="keyword">import</span> JSONParser</div><div class="line"><span class="keyword">from</span> snippets.models <span class="keyword">import</span> Snippet</div><div class="line"><span class="keyword">from</span> snippets.serializers <span class="keyword">import</span> SnippetSerializer</div></pre></td></tr></table></figure><p>首页是列出所有已存在的代码片段，或创建新的代码片段。</p><figure class="highlight python"><table><tr><td class="gutter"><pre><div class="line">1</div><div class="line">2</div><div class="line">3</div><div class="line">4</div><div class="line">5</div><div class="line">6</div><div class="line">7</div><div class="line">8</div><div class="line">9</div><div class="line">10</div><div class="line">11</div><div class="line">12</div><div class="line">13</div><div class="line">14</div><div class="line">15</div><div class="line">16</div><div class="line">17</div></pre></td><td class="code"><pre><div class="line"><span class="meta">@csrf_exempt</span></div><div class="line"><span class="function"><span class="keyword">def</span> <span class="title">snippet_list</span><span class="params">(request)</span>:</span></div><div class="line">    <span class="string">"""</span></div><div class="line">    List all code snippets, or create a new snippet.</div><div class="line">    """</div><div class="line">    <span class="keyword">if</span> request.method == <span class="string">'GET'</span>:</div><div class="line">        snippets = Snippet.objects.all()</div><div class="line">        serializer = SnippetSerializer(snippets, many=<span class="keyword">True</span>)</div><div class="line">        <span class="keyword">return</span> JsonResponse(serializer.data, safe=<span class="keyword">False</span>)</div><div class="line"></div><div class="line">    <span class="keyword">elif</span> request.method == <span class="string">'POST'</span>:</div><div class="line">        data = JSONParser().parse(request)</div><div class="line">        serializer = SnippetSerializer(data=data)</div><div class="line">        <span class="keyword">if</span> serializer.is_valid():</div><div class="line">            serializer.save()</div><div class="line">            <span class="keyword">return</span> JsonResponse(serializer.data, status=<span class="number">201</span>)</div><div class="line">        <span class="keyword">return</span> JsonResponse(serializer.errors, status=<span class="number">400</span>)</div></pre></td></tr></table></figure><p>注意，因为我们希望允许没有CSRF令牌的客户端可以通过POST访问该视图，所以我们需要添加装饰器<code>csrf_exempt</code>。正常情况下你不该这么做，REST framework视图函数实际上还有比这更合理的解决方法，但目前这已经达到我们的目的了。</p><p>同样，我们创建一个显示单个代码片段的页面，允许搜索，更新和删除代码片段。</p><figure class="highlight python"><table><tr><td class="gutter"><pre><div class="line">1</div><div class="line">2</div><div class="line">3</div><div class="line">4</div><div class="line">5</div><div class="line">6</div><div class="line">7</div><div class="line">8</div><div class="line">9</div><div class="line">10</div><div class="line">11</div><div class="line">12</div><div class="line">13</div><div class="line">14</div><div class="line">15</div><div class="line">16</div><div class="line">17</div><div class="line">18</div><div class="line">19</div><div class="line">20</div><div class="line">21</div><div class="line">22</div><div class="line">23</div><div class="line">24</div><div class="line">25</div></pre></td><td class="code"><pre><div class="line"><span class="meta">@csrf_exempt</span></div><div class="line"><span class="function"><span class="keyword">def</span> <span class="title">snippet_detail</span><span class="params">(request, pk)</span>:</span></div><div class="line">    <span class="string">"""</span></div><div class="line">    Retrieve, update or delete a code snippet.</div><div class="line">    """</div><div class="line">    <span class="keyword">try</span>:</div><div class="line">        snippet = Snippet.objects.get(pk=pk)</div><div class="line">    <span class="keyword">except</span> Snippet.DoesNotExist:</div><div class="line">        <span class="keyword">return</span> HttpResponse(status=<span class="number">404</span>)</div><div class="line"></div><div class="line">    <span class="keyword">if</span> request.method == <span class="string">'GET'</span>:</div><div class="line">        serializer = SnippetSerializer(snippet)</div><div class="line">        <span class="keyword">return</span> JsonResponse(serializer.data)</div><div class="line"></div><div class="line">    <span class="keyword">elif</span> request.method == <span class="string">'PUT'</span>:</div><div class="line">        data = JSONParser().parse(request)</div><div class="line">        serializer = SnippetSerializer(snippet, data=data)</div><div class="line">        <span class="keyword">if</span> serializer.is_valid():</div><div class="line">            serializer.save()</div><div class="line">            <span class="keyword">return</span> JsonResponse(serializer.data)</div><div class="line">        <span class="keyword">return</span> JsonResponse(serializer.errors, status=<span class="number">400</span>)</div><div class="line"></div><div class="line">    <span class="keyword">elif</span> request.method == <span class="string">'DELETE'</span>:</div><div class="line">        snippet.delete()</div><div class="line">        <span class="keyword">return</span> HttpResponse(status=<span class="number">204</span>)</div></pre></td></tr></table></figure><p>最后我们需要整合这些视图。创建<code>snippets/urls.py</code>文件：</p><figure class="highlight python"><table><tr><td class="gutter"><pre><div class="line">1</div><div class="line">2</div><div class="line">3</div><div class="line">4</div><div class="line">5</div><div class="line">6</div><div class="line">7</div><div class="line">8</div><div class="line">9</div><div class="line">10</div><div class="line">11</div><div class="line">12</div><div class="line">13</div><div class="line">14</div><div class="line">15</div><div class="line">16</div></pre></td><td class="code"><pre><div class="line"><span class="keyword">from</span> django.urls <span class="keyword">import</span> path</div><div class="line"><span class="keyword">from</span> snippets <span class="keyword">import</span> views</div><div class="line"></div><div class="line"></div><div class="line">urlpatterns = [</div><div class="line">    path(<span class="string">'snippets/'</span>, views.snippet_list),</div><div class="line">    path(<span class="string">'snippets/&lt;int:pk&gt;/'</span>, views.snippet_detail),</div><div class="line">]</div><div class="line"><span class="comment"># Django-2.0以下版本</span></div><div class="line"><span class="comment"># from django.conf.urls import url</span></div><div class="line"><span class="comment"># from snippets import views</span></div><div class="line"></div><div class="line"><span class="comment"># urlpatterns = [</span></div><div class="line"><span class="comment">#     url(r'^snippets/$', views.snippet_list),</span></div><div class="line"><span class="comment">#     url(r'^snippets/(?P&lt;pk&gt;[0-9]+)/$', views.snippet_detail),</span></div><div class="line"><span class="comment"># ]</span></div></pre></td></tr></table></figure><p>将上面的url配置整合到根url配置文件中<code>tutorial/urls.py</code>。</p><figure class="highlight python"><table><tr><td class="gutter"><pre><div class="line">1</div><div class="line">2</div><div class="line">3</div><div class="line">4</div><div class="line">5</div><div class="line">6</div><div class="line">7</div><div class="line">8</div><div class="line">9</div><div class="line">10</div><div class="line">11</div><div class="line">12</div><div class="line">13</div><div class="line">14</div></pre></td><td class="code"><pre><div class="line"><span class="keyword">from</span> django.contrib <span class="keyword">import</span> admin</div><div class="line"><span class="keyword">from</span> django.urls <span class="keyword">import</span> path</div><div class="line"><span class="keyword">from</span> django.conf.urls <span class="keyword">import</span> include</div><div class="line"></div><div class="line">urlpatterns = [</div><div class="line">    path(<span class="string">'admin/'</span>, admin.site.urls),</div><div class="line">    path(<span class="string">''</span>, include(<span class="string">'snippets.urls'</span>)),</div><div class="line">]</div><div class="line"><span class="comment"># 2.0以下</span></div><div class="line"><span class="comment"># from django.conf.urls import url, include</span></div><div class="line"><span class="comment">#</span></div><div class="line"><span class="comment"># urlpatterns = [</span></div><div class="line"><span class="comment">#     url(r'^', include('snippets.urls')),</span></div><div class="line"><span class="comment"># ]</span></div></pre></td></tr></table></figure><p>目前，我们还有许多边界条件没有处理。如果我们发送的json格式不正确，或者请求一个视图无法处理的方法时，我们会返回一个500 server error。</p><h2 id="测试我们在Web-API上的第一次尝试"><a href="#测试我们在Web-API上的第一次尝试" class="headerlink" title="测试我们在Web API上的第一次尝试"></a>测试我们在Web API上的第一次尝试</h2><p>现在我们可以启动服务器运行我们服务了。<br>先退出刚刚的shell…</p><figure class="highlight plain"><table><tr><td class="gutter"><pre><div class="line">1</div></pre></td><td class="code"><pre><div class="line">quit()</div></pre></td></tr></table></figure><p>…接着启动我们的服务器</p><figure class="highlight plain"><table><tr><td class="gutter"><pre><div class="line">1</div><div class="line">2</div><div class="line">3</div><div class="line">4</div><div class="line">5</div><div class="line">6</div><div class="line">7</div><div class="line">8</div></pre></td><td class="code"><pre><div class="line">python manage.py runserver</div><div class="line"></div><div class="line">Validating models...</div><div class="line"></div><div class="line">0 errors found</div><div class="line">Django version 1.11, using settings &apos;tutorial.settings&apos;</div><div class="line">Development server is running at http://127.0.0.1:8000/</div><div class="line">Quit the server with CONTROL-C.</div></pre></td></tr></table></figure><p>在另一个终端窗口，来测试我们的服务。</p><p>我们可以使用<code>curl</code>或者<code>httpie</code>来测试。Httpie是由python实现的一款的http客户端。</p><p>你可以通过pip来安装它：</p><figure class="highlight plain"><table><tr><td class="gutter"><pre><div class="line">1</div></pre></td><td class="code"><pre><div class="line">pip install httpie</div></pre></td></tr></table></figure><p>接着，我们尝试获取所有代码片段的列表</p><figure class="highlight"><table><tr><td class="gutter"><pre><div class="line">1</div><div class="line">2</div><div class="line">3</div><div class="line">4</div><div class="line">5</div><div class="line">6</div><div class="line">7</div><div class="line">8</div><div class="line">9</div><div class="line">10</div><div class="line">11</div><div class="line">12</div><div class="line">13</div><div class="line">14</div><div class="line">15</div><div class="line">16</div><div class="line">17</div><div class="line">18</div><div class="line">19</div><div class="line">20</div><div class="line">21</div><div class="line">22</div></pre></td><td class="code"><pre><div class="line">http http://127.0.0.1:8000/snippets/</div><div class="line"></div><div class="line">HTTP/1.1 200 OK</div><div class="line">...</div><div class="line">[</div><div class="line">  &#123;</div><div class="line">    "id": 1,</div><div class="line">    "title": "",</div><div class="line">    "code": "foo = \"bar\"\n",</div><div class="line">    "linenos": false,</div><div class="line">    "language": "python",</div><div class="line">    "style": "friendly"</div><div class="line">  &#125;,</div><div class="line">  &#123;</div><div class="line">    "id": 2,</div><div class="line">    "title": "",</div><div class="line">    "code": "print \"hello, world\"\n",</div><div class="line">    "linenos": false,</div><div class="line">    "language": "python",</div><div class="line">    "style": "friendly"</div><div class="line">  &#125;</div><div class="line">]</div></pre></td></tr></table></figure><p>或者我们可以通过它的id来访问单个代码片段:</p><figure class="highlight"><table><tr><td class="gutter"><pre><div class="line">1</div><div class="line">2</div><div class="line">3</div><div class="line">4</div><div class="line">5</div><div class="line">6</div><div class="line">7</div><div class="line">8</div><div class="line">9</div><div class="line">10</div><div class="line">11</div><div class="line">12</div></pre></td><td class="code"><pre><div class="line">http http://127.0.0.1:8000/snippets/2/</div><div class="line"></div><div class="line">HTTP/1.1 200 OK</div><div class="line">...</div><div class="line">&#123;</div><div class="line">  "id": 2,</div><div class="line">  "title": "",</div><div class="line">  "code": "print \"hello, world\"\n",</div><div class="line">  "linenos": false,</div><div class="line">  "language": "python",</div><div class="line">  "style": "friendly"</div><div class="line">&#125;</div></pre></td></tr></table></figure><p>同样地，你可以通过浏览器访问URLs来获得这些json数据。</p><h2 id="我们到什么程度了"><a href="#我们到什么程度了" class="headerlink" title="我们到什么程度了"></a>我们到什么程度了</h2><p>目前为止我们表现还不错，我们已经有了一个序列化的API，这感觉跟Django的表单API和一些常规的Django视图非常相似。</p><p>除了返回json数据，我们的视图没有做什么特别的事。还有一些边界条件的处理没有实现，但这仍是一个正常运行的Web API。</p><p>我们将在<a href="">教程2</a>开始改进它。</p><hr><p>原文：<a href="http://www.django-rest-framework.org/tutorial/1-serialization/#working-with-serializers" target="_blank" rel="external">http://www.django-rest-framework.org/tutorial/1-serialization/#working-with-serializers</a></p>]]></content>
    
    <summary type="html">
    
      &lt;h2 id=&quot;介绍&quot;&gt;&lt;a href=&quot;#介绍&quot; class=&quot;headerlink&quot; title=&quot;介绍&quot;&gt;&lt;/a&gt;介绍&lt;/h2&gt;&lt;p&gt;这个教程将创建一套简单的代码高亮的pastebin的Web API。一路上我们会介绍许多构建&lt;code&gt;REST frmaework&lt;/code&gt;的组件，并且让你有一个全面的认识，这些组件是如何组建在一起的。&lt;br&gt;
    
    </summary>
    
    
      <category term="Django" scheme="http://yoursite.com/tags/Django/"/>
    
      <category term="Django REST framework" scheme="http://yoursite.com/tags/Django-REST-framework/"/>
    
      <category term="翻译" scheme="http://yoursite.com/tags/%E7%BF%BB%E8%AF%91/"/>
    
  </entry>
  
  <entry>
    <title>Django REST framework 快速入门</title>
    <link href="http://yoursite.com/2018/02/06/Django-RESTful-framework%E5%BF%AB%E9%80%9F%E5%85%A5%E9%97%A8/"/>
    <id>http://yoursite.com/2018/02/06/Django-RESTful-framework快速入门/</id>
    <published>2018-02-05T16:22:15.000Z</published>
    <updated>2018-02-10T14:06:04.217Z</updated>
    
    <content type="html"><![CDATA[<h1 id="快速入门"><a href="#快速入门" class="headerlink" title="快速入门"></a>快速入门</h1><p>我们会创建一套简单的API来允许管理员查看和编辑系统中的用户和用户组<br><a id="more"></a></p><h2 id="创建项目"><a href="#创建项目" class="headerlink" title="创建项目"></a>创建项目</h2><p>创建一个新的Django项目<code>tutorial</code>，然后创建一个新的app<code>quickstart</code>。<br><figure class="highlight plain"><table><tr><td class="gutter"><pre><div class="line">1</div><div class="line">2</div><div class="line">3</div><div class="line">4</div><div class="line">5</div><div class="line">6</div><div class="line">7</div><div class="line">8</div><div class="line">9</div><div class="line">10</div><div class="line">11</div><div class="line">12</div><div class="line">13</div><div class="line">14</div><div class="line">15</div><div class="line">16</div><div class="line">17</div></pre></td><td class="code"><pre><div class="line"># Create the project directory</div><div class="line">mkdir tutorial</div><div class="line">cd tutorial</div><div class="line"></div><div class="line"># Create a virtualenv to isolate our package dependencies locally</div><div class="line">virtualenv env</div><div class="line">source env/bin/activate  # On Windows use `env\Scripts\activate`</div><div class="line"></div><div class="line"># Install Django and Django REST framework into the virtualenv</div><div class="line">pip install django</div><div class="line">pip install djangorestframework</div><div class="line"></div><div class="line"># Set up a new project with a single application</div><div class="line">django-admin.py startproject tutorial .  # Note the trailing &apos;.&apos; character</div><div class="line">cd tutorial</div><div class="line">django-admin.py startapp quickstart</div><div class="line">cd ..</div></pre></td></tr></table></figure></p><p>项目的结果应该像这样：<br><figure class="highlight plain"><table><tr><td class="gutter"><pre><div class="line">1</div><div class="line">2</div><div class="line">3</div><div class="line">4</div><div class="line">5</div><div class="line">6</div><div class="line">7</div><div class="line">8</div><div class="line">9</div><div class="line">10</div><div class="line">11</div><div class="line">12</div><div class="line">13</div><div class="line">14</div><div class="line">15</div><div class="line">16</div><div class="line">17</div><div class="line">18</div><div class="line">19</div></pre></td><td class="code"><pre><div class="line">$ pwd</div><div class="line">&lt;some path&gt;/tutorial</div><div class="line">$ find .</div><div class="line">.</div><div class="line">./manage.py</div><div class="line">./tutorial</div><div class="line">./tutorial/__init__.py</div><div class="line">./tutorial/quickstart</div><div class="line">./tutorial/quickstart/__init__.py</div><div class="line">./tutorial/quickstart/admin.py</div><div class="line">./tutorial/quickstart/apps.py</div><div class="line">./tutorial/quickstart/migrations</div><div class="line">./tutorial/quickstart/migrations/__init__.py</div><div class="line">./tutorial/quickstart/models.py</div><div class="line">./tutorial/quickstart/tests.py</div><div class="line">./tutorial/quickstart/views.py</div><div class="line">./tutorial/settings.py</div><div class="line">./tutorial/urls.py</div><div class="line">./tutorial/wsgi.py</div></pre></td></tr></table></figure></p><p>这看起来可能有些不寻常，在项目目录中创建了应用程序。使用项目命名空间避免扩展模块的命名冲突。</p><p>现在第一次同步你的数据库：<br><figure class="highlight plain"><table><tr><td class="gutter"><pre><div class="line">1</div></pre></td><td class="code"><pre><div class="line">python manage.py migrate</div></pre></td></tr></table></figure></p><p>我们还将创建一个初始用户<code>user</code>，密码是<code>password123</code>。在稍后的例子中我们会认证该用户。<br><figure class="highlight plain"><table><tr><td class="gutter"><pre><div class="line">1</div></pre></td><td class="code"><pre><div class="line">python manage.py createsuperuser --email admin@example.com --username admin</div></pre></td></tr></table></figure></p><p>一旦你建立一个数据库和一个初始用户并且已经准备好，打开app目录然后开始敲码…</p><h2 id="序列化器"><a href="#序列化器" class="headerlink" title="序列化器"></a>序列化器</h2><p>首先我们会定义一些序列号器。让我创建一个新的模块<code>tutorial/quickstart/serializers.py</code>我们将会使用它们来表示我们的数据。<br><figure class="highlight python"><table><tr><td class="gutter"><pre><div class="line">1</div><div class="line">2</div><div class="line">3</div><div class="line">4</div><div class="line">5</div><div class="line">6</div><div class="line">7</div><div class="line">8</div><div class="line">9</div><div class="line">10</div><div class="line">11</div><div class="line">12</div><div class="line">13</div><div class="line">14</div></pre></td><td class="code"><pre><div class="line"><span class="keyword">from</span> django.contrib.auth.models <span class="keyword">import</span> User, Group</div><div class="line"><span class="keyword">from</span> rest_framework <span class="keyword">import</span> serializers</div><div class="line"></div><div class="line"></div><div class="line"><span class="class"><span class="keyword">class</span> <span class="title">UserSerializer</span><span class="params">(serializers.HyperlinkedModelSerializer)</span>:</span></div><div class="line">    <span class="class"><span class="keyword">class</span> <span class="title">Meta</span>:</span></div><div class="line">        model = User</div><div class="line">        fields = (<span class="string">'url'</span>, <span class="string">'username'</span>, <span class="string">'email'</span>, <span class="string">'groups'</span>)</div><div class="line"></div><div class="line"></div><div class="line"><span class="class"><span class="keyword">class</span> <span class="title">GroupSerializer</span><span class="params">(serializers.HyperlinkedModelSerializer)</span>:</span></div><div class="line">    <span class="class"><span class="keyword">class</span> <span class="title">Meta</span>:</span></div><div class="line">        model = Group</div><div class="line">        fields = (<span class="string">'url'</span>, <span class="string">'name'</span>)</div></pre></td></tr></table></figure></p><p>注意我们在这个例子中使用了超链接关系，通过<code>HyperlinkedModelSerializer</code>。你也可以使用主键和其他关系，但是超链接是良好的RESTful设计。</p><h2 id="视图"><a href="#视图" class="headerlink" title="视图"></a>视图</h2><p>是的，我们最好写一些视图。打开<code>tutorial/quickstart/views.py</code>然后输入：<br><figure class="highlight python"><table><tr><td class="gutter"><pre><div class="line">1</div><div class="line">2</div><div class="line">3</div><div class="line">4</div><div class="line">5</div><div class="line">6</div><div class="line">7</div><div class="line">8</div><div class="line">9</div><div class="line">10</div><div class="line">11</div><div class="line">12</div><div class="line">13</div><div class="line">14</div><div class="line">15</div><div class="line">16</div><div class="line">17</div><div class="line">18</div><div class="line">19</div></pre></td><td class="code"><pre><div class="line"><span class="keyword">from</span> django.contrib.auth.models <span class="keyword">import</span> User, Group</div><div class="line"><span class="keyword">from</span> rest_framework <span class="keyword">import</span> viewsets</div><div class="line"><span class="keyword">from</span> tutorial.quickstart.serializers <span class="keyword">import</span> UserSerializer, GroupSerializer</div><div class="line"></div><div class="line"></div><div class="line"><span class="class"><span class="keyword">class</span> <span class="title">UserViewSet</span><span class="params">(viewsets.ModelViewSet)</span>:</span></div><div class="line">    <span class="string">"""</span></div><div class="line">    API endpoint that allows users to be viewed or edited.</div><div class="line">    """</div><div class="line">    queryset = User.objects.all().order_by(<span class="string">'-date_joined'</span>)</div><div class="line">    serializer_class = UserSerializer</div><div class="line"></div><div class="line"></div><div class="line"><span class="class"><span class="keyword">class</span> <span class="title">GroupViewSet</span><span class="params">(viewsets.ModelViewSet)</span>:</span></div><div class="line">    <span class="string">"""</span></div><div class="line">    API endpoint that allows groups to be viewed or edited.</div><div class="line">    """</div><div class="line">    queryset = Group.objects.all()</div><div class="line">    serializer_class = GroupSerializer</div></pre></td></tr></table></figure></p><p>我们不是写许多视图，而是将所有常见的行为分组成类<code>ViewSets</code>。</p><p>如果我们需要，我们可以很容易的把这些分解为单独的视图，但是使用viewsets维护视图逻辑易于管理也非常简洁。</p><h2 id="URLs"><a href="#URLs" class="headerlink" title="URLs"></a>URLs</h2><p>Okay，现在让我将API接到URLs。打开<code>tutorial/urls.py</code>…<br><figure class="highlight python"><table><tr><td class="gutter"><pre><div class="line">1</div><div class="line">2</div><div class="line">3</div><div class="line">4</div><div class="line">5</div><div class="line">6</div><div class="line">7</div><div class="line">8</div><div class="line">9</div><div class="line">10</div><div class="line">11</div><div class="line">12</div><div class="line">13</div><div class="line">14</div></pre></td><td class="code"><pre><div class="line"><span class="keyword">from</span> django.conf.urls <span class="keyword">import</span> url, include</div><div class="line"><span class="keyword">from</span> rest_framework <span class="keyword">import</span> routers</div><div class="line"><span class="keyword">from</span> tutorial.quickstart <span class="keyword">import</span> views</div><div class="line"></div><div class="line">router = routers.DefaultRouter()</div><div class="line">router.register(<span class="string">r'users'</span>, views.UserViewSet)</div><div class="line">router.register(<span class="string">r'groups'</span>, views.GroupViewSet)</div><div class="line"></div><div class="line"><span class="comment"># Wire up our API using automatic URL routing.</span></div><div class="line"><span class="comment"># Additionally, we include login URLs for the browsable API.</span></div><div class="line">urlpatterns = [</div><div class="line">    url(<span class="string">r'^'</span>, include(router.urls)),</div><div class="line">    url(<span class="string">r'^api-auth/'</span>, include(<span class="string">'rest_framework.urls'</span>, namespace=<span class="string">'rest_framework'</span>))</div><div class="line">]</div></pre></td></tr></table></figure></p><p>因为我们使用viewsets代替普通的视图，所以通过简单地将viewsets注册为一个路由类，我们可以为我们API自动地生成URL配置。</p><p>如果我们需要对API URLs有更多操作，我们可以使用普通的视图并且明确地编写URL配置文件。</p><p>最后，我们通过browsable API包含了默认的登陆和注销视图。这是可选的，但是如果你的API需要认证功能和你想使用browsable API，这将非常有用。</p><h2 id="设置"><a href="#设置" class="headerlink" title="设置"></a>设置</h2><p>把<code>rest_framework</code>添加到<code>INSTALLED_APPS</code>。设置模块在<code>tutorial/settings.py</code></p><figure class="highlight python"><table><tr><td class="gutter"><pre><div class="line">1</div><div class="line">2</div><div class="line">3</div><div class="line">4</div></pre></td><td class="code"><pre><div class="line">INSTALLED_APPS = (</div><div class="line">    ...</div><div class="line">    <span class="string">'rest_framework'</span>,</div><div class="line">)</div></pre></td></tr></table></figure><p>Okay，我们完成了。</p><hr><h2 id="测试我们的API"><a href="#测试我们的API" class="headerlink" title="测试我们的API"></a>测试我们的API</h2><p>我们现在准备测试我们刚刚创建的API。让我们通过命令行启动服务器。<br><figure class="highlight plain"><table><tr><td class="gutter"><pre><div class="line">1</div></pre></td><td class="code"><pre><div class="line">python manage.py runserver</div></pre></td></tr></table></figure></p><p>我们可以访问我们的API，通过命令行或者使用工具：curl…<br><figure class="highlight plain"><table><tr><td class="gutter"><pre><div class="line">1</div><div class="line">2</div><div class="line">3</div><div class="line">4</div><div class="line">5</div><div class="line">6</div><div class="line">7</div><div class="line">8</div><div class="line">9</div><div class="line">10</div><div class="line">11</div><div class="line">12</div><div class="line">13</div><div class="line">14</div><div class="line">15</div><div class="line">16</div><div class="line">17</div><div class="line">18</div><div class="line">19</div><div class="line">20</div></pre></td><td class="code"><pre><div class="line">bash: curl -H &apos;Accept: application/json; indent=4&apos; -u admin:password123 http://127.0.0.1:8000/users/</div><div class="line">&#123;</div><div class="line">    &quot;count&quot;: 2,</div><div class="line">    &quot;next&quot;: null,</div><div class="line">    &quot;previous&quot;: null,</div><div class="line">    &quot;results&quot;: [</div><div class="line">        &#123;</div><div class="line">            &quot;email&quot;: &quot;admin@example.com&quot;,</div><div class="line">            &quot;groups&quot;: [],</div><div class="line">            &quot;url&quot;: &quot;http://127.0.0.1:8000/users/1/&quot;,</div><div class="line">            &quot;username&quot;: &quot;admin&quot;</div><div class="line">        &#125;,</div><div class="line">        &#123;</div><div class="line">            &quot;email&quot;: &quot;tom@example.com&quot;,</div><div class="line">            &quot;groups&quot;: [                ],</div><div class="line">            &quot;url&quot;: &quot;http://127.0.0.1:8000/users/2/&quot;,</div><div class="line">            &quot;username&quot;: &quot;tom&quot;</div><div class="line">        &#125;</div><div class="line">    ]</div><div class="line">&#125;</div></pre></td></tr></table></figure></p><p>或者使用httpie，命令行工具…<br><figure class="highlight plain"><table><tr><td class="gutter"><pre><div class="line">1</div><div class="line">2</div><div class="line">3</div><div class="line">4</div><div class="line">5</div><div class="line">6</div><div class="line">7</div><div class="line">8</div><div class="line">9</div><div class="line">10</div><div class="line">11</div><div class="line">12</div><div class="line">13</div><div class="line">14</div><div class="line">15</div><div class="line">16</div><div class="line">17</div><div class="line">18</div><div class="line">19</div><div class="line">20</div><div class="line">21</div><div class="line">22</div><div class="line">23</div></pre></td><td class="code"><pre><div class="line">bash: http -a admin:password123 http://127.0.0.1:8000/users/</div><div class="line"></div><div class="line">HTTP/1.1 200 OK</div><div class="line">...</div><div class="line">&#123;</div><div class="line">    &quot;count&quot;: 2,</div><div class="line">    &quot;next&quot;: null,</div><div class="line">    &quot;previous&quot;: null,</div><div class="line">    &quot;results&quot;: [</div><div class="line">        &#123;</div><div class="line">            &quot;email&quot;: &quot;admin@example.com&quot;,</div><div class="line">            &quot;groups&quot;: [],</div><div class="line">            &quot;url&quot;: &quot;http://localhost:8000/users/1/&quot;,</div><div class="line">            &quot;username&quot;: &quot;paul&quot;</div><div class="line">        &#125;,</div><div class="line">        &#123;</div><div class="line">            &quot;email&quot;: &quot;tom@example.com&quot;,</div><div class="line">            &quot;groups&quot;: [                ],</div><div class="line">            &quot;url&quot;: &quot;http://127.0.0.1:8000/users/2/&quot;,</div><div class="line">            &quot;username&quot;: &quot;tom&quot;</div><div class="line">        &#125;</div><div class="line">    ]</div><div class="line">&#125;</div></pre></td></tr></table></figure></p><p>或者直接使用浏览器访问<code>http://127.0.0.1:8000/users/</code>…<br><img src="http://www.django-rest-framework.org/img/quickstart.png" alt=""></p><p>如果你使用浏览器，首先确保你已经通过右上角登陆。</p><p>好的，就是这么简单！</p><p>如果你想更深入了解，可以浏览<a href="http://www.django-rest-framework.org/#api-guide" target="_blank" rel="external">API guide</a></p><p>原文：<a href="http://www.django-rest-framework.org/tutorial/quickstart/#quickstart" target="_blank" rel="external">http://www.django-rest-framework.org/tutorial/quickstart/#quickstart</a></p>]]></content>
    
    <summary type="html">
    
      &lt;h1 id=&quot;快速入门&quot;&gt;&lt;a href=&quot;#快速入门&quot; class=&quot;headerlink&quot; title=&quot;快速入门&quot;&gt;&lt;/a&gt;快速入门&lt;/h1&gt;&lt;p&gt;我们会创建一套简单的API来允许管理员查看和编辑系统中的用户和用户组&lt;br&gt;
    
    </summary>
    
    
      <category term="Django" scheme="http://yoursite.com/tags/Django/"/>
    
      <category term="Django REST framework" scheme="http://yoursite.com/tags/Django-REST-framework/"/>
    
      <category term="翻译" scheme="http://yoursite.com/tags/%E7%BF%BB%E8%AF%91/"/>
    
  </entry>
  
  <entry>
    <title>数据库建模</title>
    <link href="http://yoursite.com/2018/01/07/%E6%95%B0%E6%8D%AE%E5%BA%93%E5%BB%BA%E6%A8%A1/"/>
    <id>http://yoursite.com/2018/01/07/数据库建模/</id>
    <published>2018-01-07T02:51:38.000Z</published>
    <updated>2018-02-08T09:33:01.654Z</updated>
    
    <content type="html"><![CDATA[<a id="more"></a><h2 id="一-数据库设计过程"><a href="#一-数据库设计过程" class="headerlink" title="一.数据库设计过程"></a>一.数据库设计过程</h2><ol><li>需求分析</li><li>概念设计</li><li>逻辑设计</li><li>模式求精</li><li>物理设计</li><li>应用与安全设计</li></ol><h2 id="二-E-R模型基本概念-实体集-联系集-属性"><a href="#二-E-R模型基本概念-实体集-联系集-属性" class="headerlink" title="二.E-R模型基本概念(实体集,联系集,属性)"></a>二.E-R模型基本概念(实体集,联系集,属性)</h2><h3 id="1-实体与实体集"><a href="#1-实体与实体集" class="headerlink" title="1. 实体与实体集"></a>1. 实体与实体集</h3><h3 id="2-属性及其分类"><a href="#2-属性及其分类" class="headerlink" title="2. 属性及其分类"></a>2. 属性及其分类</h3><ol><li><strong>简单属性,复合属性</strong></li><li><strong>单值属性,多值属性</strong></li><li><strong>派生属性</strong></li></ol><h3 id="3-联系与联系集"><a href="#3-联系与联系集" class="headerlink" title="3. 联系与联系集"></a>3. 联系与联系集</h3><ol><li><strong>多联系</strong>:各实体之间可以有多种不同的联系.</li><li><strong>实体的角色</strong>:当同一个实体集在一个联系集中参与的次数大于一次,且每次以不同的角色参与时,要用显示的角色名定义一个实体参与联系的方式.</li><li><strong>联系集的度</strong>:联系集的实体集的数目.</li></ol><h2 id="三-约束"><a href="#三-约束" class="headerlink" title="三.约束"></a>三.约束</h2><h3 id="1-映射约束"><a href="#1-映射约束" class="headerlink" title="1. 映射约束"></a>1. 映射约束</h3><ol><li>一对一</li><li>一对多</li><li>多对一</li><li>多对多</li></ol><h3 id="2-码约束"><a href="#2-码约束" class="headerlink" title="2. 码约束"></a>2. 码约束</h3><h4 id="①实体集的码"><a href="#①实体集的码" class="headerlink" title="①实体集的码"></a>①实体集的码</h4><ol><li><strong>超码</strong>:唯一标识一个实体的一个或多个属性的集合.</li><li><strong>候选码</strong>:一个超码的任意真子集都不能成为超码,这样最小的超码成为候选码.</li><li><strong>主码</strong>:从多个候选码中选择一个作为实体集的主码.</li></ol><h4 id="②主码选择原则"><a href="#②主码选择原则" class="headerlink" title="②主码选择原则"></a>②主码选择原则</h4><ol><li>选择属性长度最短的候选码</li><li>尽量选择包含单个属性的码,而不是复合候选码</li><li>选择在数据库系统生命周期内属性值最少变化的候选码</li><li>选择在数据库系统生命周期内更可能包含唯一值的候选码</li></ol><h4 id="③联系集的码"><a href="#③联系集的码" class="headerlink" title="③联系集的码"></a>③联系集的码</h4><blockquote><p>每一个联系集必须存在候选码并选择其中的一个候选码作为主码</p></blockquote><p><strong>一对一联系集</strong>:主码可以使用任何一方实体集的主码<br><strong>一对多(多对一)联系集</strong>:主码由”多”的一方实体集的主码组成<br><strong>多对多联系集</strong>:主码由参与联系集中所有实体集的主码组成</p><h4 id="④联系集的属性安置"><a href="#④联系集的属性安置" class="headerlink" title="④联系集的属性安置"></a>④联系集的属性安置</h4><p><strong>一对一联系集的属性</strong>:可安置在任一边的实体集上<br><strong>一对多联系集的属性</strong>:可安置于联系集上,也可安置在多的那一边的实体集上<br><strong>多对多联系集的属性</strong>:只能安置在联系集上,不能放到相关联的实体集上</p><h3 id="3-依赖约束"><a href="#3-依赖约束" class="headerlink" title="3. 依赖约束"></a>3. 依赖约束</h3><p><strong>依赖实体集</strong>:联系中的一种实体的存在依赖于该联系集中联系的存在<br>    如:<strong>销货单</strong>实体集与<strong>商品销售</strong>联系集<br><strong>弱实体集</strong>:联系中的一种实体的存在依赖于其他实体集中实体的存在<br>    如:<strong>开课班</strong>实体集与<strong>课程</strong>实体集</p><h3 id="4-参与约束"><a href="#4-参与约束" class="headerlink" title="4. 参与约束"></a>4. 参与约束</h3><p>实体集与联系集:</p><ol><li>全部参与</li><li>部分参与</li></ol><h3 id="5-多值联系"><a href="#5-多值联系" class="headerlink" title="5. 多值联系"></a>5. 多值联系</h3><p>同一个给定的联系集中,相关联的相同实体之间可能存在多个联系,如<strong>客户</strong>与<strong>银行</strong>之间<strong>多对多</strong>贷款联系集,及同时一个<strong>银行</strong>可以向多个<strong>客户</strong>发放贷款的<strong>一对多</strong>联系集.</p><hr><h2 id="四-弱实体集"><a href="#四-弱实体集" class="headerlink" title="四.弱实体集"></a>四.弱实体集</h2><p>某些实体集的属性不足以形成主码,他们必须依赖于其他实体集的存在而存在.</p><p><strong>部分码</strong>:用来标识弱实体的属性<br>弱实体集中的实体是由标识实体集中的<strong>主码</strong>与其<strong>部分码</strong>共同标识.</p><h2 id="五-扩展E-R特征"><a href="#五-扩展E-R特征" class="headerlink" title="五.扩展E-R特征"></a>五.扩展E-R特征</h2><p><strong>1. 类的层次</strong><br>E-R模型使用实体集的继承和ISA联系来描述这种概念上的继承.<br>ISA关系可以从两个方向进行设计:<br>①自上而下,先设计父类实体集,再将父类具体化为其他子类<br>②自下而上,先具体化子类实体集,再将子类中的共同属性提取出来,泛化为父类</p><p><strong>2. 聚合</strong><br>聚合是一种抽象,它将一个联系集及其相关联的实体集抽象为一个<strong>联系实体集</strong>对待,然后建立该联系实体集与其他实体集之间的联系集.</p><h2 id="六-E-R建模问题"><a href="#六-E-R建模问题" class="headerlink" title="六.E-R建模问题"></a>六.E-R建模问题</h2><h3 id="E-R建模的基本原则"><a href="#E-R建模的基本原则" class="headerlink" title="E-R建模的基本原则"></a>E-R建模的基本原则</h3><p><strong>1.忠实性</strong>: 设计应忠实于应用需求<br><strong>2.简单性</strong>: 除非有绝对需要,否则不要在设计中增加更多成分<br><strong>3.避免冗余</strong>: 一个对象只存放在一个地方<br><strong>4.选择实体集还是属性</strong>:<br>①不可再分<br>②不能和其他实体相联系<br>满足上述两条规则均可作为属性对待<br><strong>5.选择实体集还是联系集</strong>:<br>实体集一般对应现实生活中实际存在的事物<br>联系集一般对应一种动作<br><strong>6.多元联系转化为二元联系</strong>:</p><h3 id="依赖约束的建模"><a href="#依赖约束的建模" class="headerlink" title="依赖约束的建模"></a>依赖约束的建模</h3><h3 id="多值联系的建模"><a href="#多值联系的建模" class="headerlink" title="多值联系的建模"></a>多值联系的建模</h3><ol><li>将多值联系建模为弱实体集</li><li>将多值联系建模为依赖实体集</li></ol><h2 id="E-R模型的表示"><a href="#E-R模型的表示" class="headerlink" title="E-R模型的表示"></a>E-R模型的表示</h2><ol><li>实体集:矩形</li><li>弱实体集:双矩形</li><li>属性:椭圆</li><li>多值属性:双椭圆</li><li>派生属性:虚线椭圆</li><li>联系(集):菱形</li><li>标识联系集:双菱形</li><li>属性与实体之间用连线表示</li><li>加下划线的属性为实体集的主码</li><li>虚下划线表示弱实体的部分码</li><li>“→”指向参与联系集中”一”方实体集,”-“指向参与联系集”多”方实体集</li><li>联系实体集:带菱形的矩形</li></ol>]]></content>
    
    <summary type="html">
    
      
      
        &lt;a id=&quot;more&quot;&gt;&lt;/a&gt;
&lt;h2 id=&quot;一-数据库设计过程&quot;&gt;&lt;a href=&quot;#一-数据库设计过程&quot; class=&quot;headerlink&quot; title=&quot;一.数据库设计过程&quot;&gt;&lt;/a&gt;一.数据库设计过程&lt;/h2&gt;&lt;ol&gt;
&lt;li&gt;需求分析&lt;/li&gt;
&lt;li&gt;概念设计
      
    
    </summary>
    
    
      <category term="数据库" scheme="http://yoursite.com/tags/%E6%95%B0%E6%8D%AE%E5%BA%93/"/>
    
      <category term="review" scheme="http://yoursite.com/tags/review/"/>
    
  </entry>
  
  <entry>
    <title>乐观锁-悲观锁</title>
    <link href="http://yoursite.com/2017/05/21/%E4%B9%90%E8%A7%82%E9%94%81-%E6%82%B2%E8%A7%82%E9%94%81/"/>
    <id>http://yoursite.com/2017/05/21/乐观锁-悲观锁/</id>
    <published>2017-05-21T08:39:48.000Z</published>
    <updated>2018-02-10T13:56:16.559Z</updated>
    
    <content type="html"><![CDATA[<a id="more"></a><h2 id="悲观锁"><a href="#悲观锁" class="headerlink" title="悲观锁"></a>悲观锁</h2><p>对数据被外界修改持保守态度，在整个数据处理过程中，将数据处于<strong>锁定状态</strong>。其实现依靠数据库的锁机制，以保证操作最大程度的独占性。但随之而来的就是数据库性能的大量开销。<br>以<strong>MySQL InnoDB</strong>为例,当使用<code>SELECT FOR UPDATE</code>就会使用悲观锁，前提是把事务自动提交取消<br><figure class="highlight sql"><table><tr><td class="gutter"><pre><div class="line">1</div></pre></td><td class="code"><pre><div class="line"><span class="keyword">set</span> autocommit = <span class="number">0</span>;</div></pre></td></tr></table></figure></p><p>使用悲观锁的原理就是，当我们在查询出信息后就把当前的数据锁定，直到我们修改完毕后再解锁。<br>根据查询条件的不同，锁定的范围也不同</p><ol><li>当查询条件中<strong>指定明确主键</strong>，并且有此数据——–行级锁（row lock）</li><li>当查询条件中<strong>指定明确主键</strong>，但无次数据———-无锁</li><li>当查询条件中<strong>无主键</strong>————————-表级锁（table lock）</li><li>当查询条件中<strong>主键不明确</strong>———————-表级锁（table lock）</li></ol><h2 id="乐观锁"><a href="#乐观锁" class="headerlink" title="乐观锁"></a>乐观锁</h2><p>乐观锁大多基于<strong>数据版本记录机制</strong>实现，即为数据增加一个版本标识，在基于数据库表的版本解决方案，一般是通过为数据库表增加一个 “version” 字段来实现。也可以采用另一种方式，同样是在需要乐观锁控制的table中增加一个字段，名称无所谓，字段类型使用时间戳timestamp中，<br><strong>操作步骤</strong></p><ol><li>读取出数据时，将此版本号（时间戳）一同读出</li><li>更新时，比较数据库中该数据当前的版本号和手上的版本号，不一致说明版本冲突，一致则OK，将版本号+1或者获取当前时间戳后将数据更新回数据库</li></ol><p><strong>缺点</strong><br>乐观锁机制往往基于系统中的数据存储逻辑，那么来自外部系统的更新操作不受我们系统的控制，因此可能会造成脏数据被更新到数据库中。<br><strong>解决</strong><br>如将乐观锁策略在数据库存储过程中实现，对外只开放基于此存储过程的数据更新途径，而不是将数据库表直接对外公开</p><h2 id="参考"><a href="#参考" class="headerlink" title="参考"></a>参考</h2><p><a href="https://www.36nu.com/post/162.html" target="_blank" rel="external">muyuren | mysql悲观锁详解</a></p><p><a href="https://www.36nu.com/post/163.html" target="_blank" rel="external">muyuren | mysql乐观锁详解</a></p>]]></content>
    
    <summary type="html">
    
      
      
        &lt;a id=&quot;more&quot;&gt;&lt;/a&gt;
&lt;h2 id=&quot;悲观锁&quot;&gt;&lt;a href=&quot;#悲观锁&quot; class=&quot;headerlink&quot; title=&quot;悲观锁&quot;&gt;&lt;/a&gt;悲观锁&lt;/h2&gt;&lt;p&gt;对数据被外界修改持保守态度，在整个数据处理过程中，将数据处于&lt;strong&gt;锁定状态&lt;/stro
      
    
    </summary>
    
    
      <category term="数据库" scheme="http://yoursite.com/tags/%E6%95%B0%E6%8D%AE%E5%BA%93/"/>
    
  </entry>
  
  <entry>
    <title>Hibernate NotNull NotEmpty NotBlank区别</title>
    <link href="http://yoursite.com/2017/05/10/Hibernate-NotNull-NotEmpty-NotBlank%E5%8C%BA%E5%88%AB/"/>
    <id>http://yoursite.com/2017/05/10/Hibernate-NotNull-NotEmpty-NotBlank区别/</id>
    <published>2017-05-10T12:28:48.000Z</published>
    <updated>2018-02-08T09:29:15.724Z</updated>
    
    <content type="html"><![CDATA[<a id="more"></a><h2 id="NotNull"><a href="#NotNull" class="headerlink" title="@NotNull"></a>@NotNull</h2><p>不允许为null，但可以是empty</p><h2 id="NotEmpty"><a href="#NotEmpty" class="headerlink" title="@NotEmpty"></a>@NotEmpty</h2><p>不允许为null且长度要大于0</p><h2 id="NotBlank"><a href="#NotBlank" class="headerlink" title="@NotBlank"></a>@NotBlank</h2><p>只能作用在String上，不能为null，而且调用trim()后，长度必须大于0</p><h2 id="例子"><a href="#例子" class="headerlink" title="例子"></a>例子</h2><figure class="highlight java"><table><tr><td class="gutter"><pre><div class="line">1</div><div class="line">2</div><div class="line">3</div><div class="line">4</div><div class="line">5</div><div class="line">6</div><div class="line">7</div><div class="line">8</div><div class="line">9</div><div class="line">10</div><div class="line">11</div><div class="line">12</div><div class="line">13</div><div class="line">14</div><div class="line">15</div><div class="line">16</div><div class="line">17</div><div class="line">18</div><div class="line">19</div></pre></td><td class="code"><pre><div class="line">String name = <span class="keyword">null</span>;</div><div class="line">NotNull = <span class="keyword">false</span></div><div class="line">NotEmpty = <span class="keyword">false</span></div><div class="line">NotBlank = <span class="keyword">false</span></div><div class="line"></div><div class="line">String nam = <span class="string">""</span>;</div><div class="line">NotNull = <span class="keyword">true</span></div><div class="line">NotEmpty = <span class="keyword">false</span></div><div class="line">NotBlank = <span class="keyword">false</span></div><div class="line"></div><div class="line">String name = <span class="string">"  "</span>;</div><div class="line">NotNull = <span class="keyword">true</span></div><div class="line">NotEmpty = <span class="keyword">true</span></div><div class="line">NotBlank = <span class="keyword">false</span></div><div class="line"></div><div class="line">String name = <span class="string">"zojian"</span></div><div class="line">NotNull = <span class="keyword">true</span></div><div class="line">NotEmpty = <span class="keyword">true</span></div><div class="line">NotBlank = <span class="keyword">true</span></div></pre></td></tr></table></figure>]]></content>
    
    <summary type="html">
    
      
      
        &lt;a id=&quot;more&quot;&gt;&lt;/a&gt;
&lt;h2 id=&quot;NotNull&quot;&gt;&lt;a href=&quot;#NotNull&quot; class=&quot;headerlink&quot; title=&quot;@NotNull&quot;&gt;&lt;/a&gt;@NotNull&lt;/h2&gt;&lt;p&gt;不允许为null，但可以是empty&lt;/p&gt;
&lt;h2 id=
      
    
    </summary>
    
    
      <category term="Hibernate" scheme="http://yoursite.com/tags/Hibernate/"/>
    
  </entry>
  
  <entry>
    <title>Spring4基于注解加载properties文件方式</title>
    <link href="http://yoursite.com/2017/05/09/Spring4%E6%B3%A8%E5%85%A5properties%E6%96%87%E4%BB%B6%E6%96%B9%E5%BC%8F/"/>
    <id>http://yoursite.com/2017/05/09/Spring4注入properties文件方式/</id>
    <published>2017-05-09T13:24:08.000Z</published>
    <updated>2018-02-08T09:30:42.382Z</updated>
    
    <content type="html"><![CDATA[<a id="more"></a><h2 id="PropertySource注解"><a href="#PropertySource注解" class="headerlink" title="@PropertySource注解"></a>@PropertySource注解</h2><p>将properties配置文件中的值存储到Spring的 Environment中，Environment接口提供方法去读取配置文件中的值，参数是properties文件中定义的key值</p><figure class="highlight java"><table><tr><td class="gutter"><pre><div class="line">1</div><div class="line">2</div><div class="line">3</div><div class="line">4</div></pre></td><td class="code"><pre><div class="line"><span class="meta">@PropertySource</span>(<span class="string">"classpath:message.properties"</span>)</div><div class="line"><span class="keyword">public</span> <span class="class"><span class="keyword">class</span> <span class="title">AppConfig</span> <span class="keyword">extends</span> <span class="title">WebMvcConfigurerAdapter</span> </span>&#123;</div><div class="line"><span class="comment">//something</span></div><div class="line">&#125;</div></pre></td></tr></table></figure><h2 id="多个配置文件-PropertySources注解"><a href="#多个配置文件-PropertySources注解" class="headerlink" title="多个配置文件@PropertySources注解"></a>多个配置文件@PropertySources注解</h2><figure class="highlight java"><table><tr><td class="gutter"><pre><div class="line">1</div><div class="line">2</div><div class="line">3</div><div class="line">4</div><div class="line">5</div><div class="line">6</div><div class="line">7</div></pre></td><td class="code"><pre><div class="line"><span class="meta">@PropertySources</span>(&#123;</div><div class="line"><span class="meta">@PropertySource</span>(<span class="string">"classpath:config.properties"</span>),</div><div class="line"><span class="meta">@PropertySource</span>(<span class="string">"classpath:db.properties"</span>)</div><div class="line">&#125;)</div><div class="line"><span class="keyword">public</span> <span class="class"><span class="keyword">class</span> <span class="title">AppConfig</span> </span>&#123;</div><div class="line"><span class="comment">//something</span></div><div class="line">&#125;</div></pre></td></tr></table></figure><h2 id="ignoreResourceNotFound属性"><a href="#ignoreResourceNotFound属性" class="headerlink" title="ignoreResourceNotFound属性"></a>ignoreResourceNotFound属性</h2><p>如果<em>*</em>.properties不存在或找不到,系统则会抛出异常FileNotFoundException。<br>但是ignoreResourceNotFound设为true之后会忽略找不到的文件</p><figure class="highlight java"><table><tr><td class="gutter"><pre><div class="line">1</div><div class="line">2</div><div class="line">3</div><div class="line">4</div><div class="line">5</div></pre></td><td class="code"><pre><div class="line"><span class="meta">@PropertySource</span>(value=<span class="string">"classpath:missing.properties"</span></div><div class="line">  ,ignoreResourceNotFound=<span class="keyword">true</span>)</div><div class="line"><span class="keyword">public</span> <span class="class"><span class="keyword">class</span> <span class="title">AppConfig</span> </span>&#123;</div><div class="line"><span class="comment">//something</span></div><div class="line">&#125;</div></pre></td></tr></table></figure>]]></content>
    
    <summary type="html">
    
      
      
        &lt;a id=&quot;more&quot;&gt;&lt;/a&gt;
&lt;h2 id=&quot;PropertySource注解&quot;&gt;&lt;a href=&quot;#PropertySource注解&quot; class=&quot;headerlink&quot; title=&quot;@PropertySource注解&quot;&gt;&lt;/a&gt;@PropertySource注解&lt;/
      
    
    </summary>
    
    
      <category term="Spring" scheme="http://yoursite.com/tags/Spring/"/>
    
  </entry>
  
  <entry>
    <title>[读薄系列]Java并发编程的艺术笔记</title>
    <link href="http://yoursite.com/2017/05/06/Java%E5%B9%B6%E5%8F%91%E7%BC%96%E7%A8%8B%E7%9A%84%E8%89%BA%E6%9C%AF%E7%AC%94%E8%AE%B0/"/>
    <id>http://yoursite.com/2017/05/06/Java并发编程的艺术笔记/</id>
    <published>2017-05-06T12:59:04.000Z</published>
    <updated>2018-02-08T09:29:25.798Z</updated>
    
    <content type="html"><![CDATA[<a id="more"></a><h1 id="1-并发编程的挑战"><a href="#1-并发编程的挑战" class="headerlink" title="1.并发编程的挑战"></a>1.并发编程的挑战</h1><h2 id="什么是上下文切换"><a href="#什么是上下文切换" class="headerlink" title="什么是上下文切换"></a>什么是上下文切换</h2><p>CPU通过时间片分配算法循环执行任务[线程]，当任务执行完一个时间片后会切换到下一个任务，在切换前会保存上一个任务的状态，以便下次切换回来时可以再加载这个任务的状态。所以任务从<strong>保存</strong>到<strong>加载</strong>的过程就是一次上下文切换。</p><h2 id="如何减少上下文切换"><a href="#如何减少上下文切换" class="headerlink" title="如何减少上下文切换"></a>如何减少上下文切换</h2><ol><li>无锁并发编程：如数据取模分段，不同线程处理不同数据</li><li>CAS算法：Atomic包使用CAS算法来更新数据， 而不需要加锁</li><li>使用最少线程：避免创建不必要的线程，使得大多数线程处于等待状态</li><li>协程：在单线程里实现多任务调度，并在单线程里维持多个任务的切换</li></ol><h2 id="如何避免死锁"><a href="#如何避免死锁" class="headerlink" title="如何避免死锁"></a>如何避免死锁</h2><ol><li>避免一个线程同时获得多个锁</li><li>避免一个锁同时占用多个资源</li><li>限制加锁顺序</li><li>尝试使用定时锁 lock.tryLock(timeout)</li><li>对应数据库锁，加锁和解锁必须在同一个数据库连接里</li></ol><h1 id="2-Java并发机制底层实现原理"><a href="#2-Java并发机制底层实现原理" class="headerlink" title="2.Java并发机制底层实现原理"></a>2.Java并发机制底层实现原理</h1><h2 id="volatile"><a href="#volatile" class="headerlink" title="volatile"></a>volatile</h2><blockquote><p>轻量级的synchronized，在多处理器开发中保证了共享变量的“可见性”（当一个线程修改一个共享变量时，另一个线程能读到这个修改的值）<br>比synchronized的使用和执行成本低，因为它不会引起线程上下文的切换和调度</p></blockquote><h3 id="背景"><a href="#背景" class="headerlink" title="背景"></a>背景</h3><p>为了提高处理速度，CPU不直接和内存进行通信，而是将系统内存的数据读到内部缓存（L1,L2,L3）后再操作，但操作完不确定何时会写回内存。这样可能导致其他CPU不能获取到共享变量的最新值。</p><h3 id="实现原理"><a href="#实现原理" class="headerlink" title="实现原理"></a>实现原理</h3><p>在x86处理器下通过工具获取JIT编译器生成的汇编指令来看看对Volatile进行写操作CPU</p><table><thead><tr><th>类别</th><th>代码</th></tr></thead><tbody><tr><td>Java代码</td><td><code>instance = new Singleton(); //instance是volatile变量</code></td></tr><tr><td>汇编指令</td><td><code>0x01a3de1d: movb $0x0,0x1104800(%esi);0x01a3de24: lock addl $0x0,(%esp);</code></td></tr></tbody></table><p><strong>Lock前缀的命令作两件事：</strong></p><ol><li>将当前CPU缓存行的数据写回到内存</li><li>令其他CPU里缓存了该内存地址的数据失效</li></ol><p><strong>缓存一致性协议</strong><br>每个CPU通过嗅探在总线中传播的数据来检查自己的缓存的值是否过期，当CPU发现自己缓存行对应的内存地址被修改，就会将当前处理器的缓存行设置成无效状态，当CPU对这个数据进行修改操作时，会重新从系统内存中把数据读到CPU缓存中。</p><h3 id="使用优化"><a href="#使用优化" class="headerlink" title="使用优化"></a>使用优化</h3><p>LinkedTransferQueue部分源码<br><figure class="highlight java"><table><tr><td class="gutter"><pre><div class="line">1</div><div class="line">2</div><div class="line">3</div><div class="line">4</div><div class="line">5</div><div class="line">6</div><div class="line">7</div><div class="line">8</div><div class="line">9</div><div class="line">10</div><div class="line">11</div><div class="line">12</div><div class="line">13</div><div class="line">14</div><div class="line">15</div><div class="line">16</div><div class="line">17</div><div class="line">18</div><div class="line">19</div><div class="line">20</div><div class="line">21</div><div class="line">22</div><div class="line">23</div><div class="line">24</div><div class="line">25</div><div class="line">26</div></pre></td><td class="code"><pre><div class="line"><span class="comment">/** head of the queue */</span></div><div class="line"><span class="keyword">private</span> <span class="keyword">transient</span> <span class="keyword">final</span> PaddedAtomicReference &lt; QNode &gt; head;</div><div class="line"></div><div class="line"><span class="comment">/** tail of the queue */</span></div><div class="line"></div><div class="line"><span class="keyword">private</span> <span class="keyword">transient</span> <span class="keyword">final</span> PaddedAtomicReference &lt; QNode &gt; tail;</div><div class="line"></div><div class="line"></div><div class="line"><span class="keyword">static</span> <span class="keyword">final</span> <span class="class"><span class="keyword">class</span> <span class="title">PaddedAtomicReference</span> &lt; <span class="title">T</span> &gt; <span class="keyword">extends</span> <span class="title">AtomicReference</span> &lt; <span class="title">T</span> &gt; </span>&#123;</div><div class="line"></div><div class="line">    <span class="comment">// enough padding for 64bytes with 4byte refs </span></div><div class="line">    Object p0, p1, p2, p3, p4, p5, p6, p7, p8, p9, pa, pb, pc, pd, pe;</div><div class="line"></div><div class="line">    PaddedAtomicReference(T r) &#123;</div><div class="line"></div><div class="line">        <span class="keyword">super</span>(r);</div><div class="line"></div><div class="line">    &#125;</div><div class="line"></div><div class="line">&#125;</div><div class="line"></div><div class="line"><span class="keyword">public</span> <span class="class"><span class="keyword">class</span> <span class="title">AtomicReference</span> &lt; <span class="title">V</span> &gt; <span class="keyword">implements</span> <span class="title">java</span>.<span class="title">io</span>.<span class="title">Serializable</span> </span>&#123;</div><div class="line"></div><div class="line">    <span class="keyword">private</span> <span class="keyword">volatile</span> V value;</div><div class="line"></div><div class="line">    <span class="comment">//省略其他代码 ｝</span></div></pre></td></tr></table></figure></p><p>因为缓存行是64个字节且不支持部分填充缓存，这意味着，如果队头队尾不足64字节，有可能他们会读到同一个缓存行中，那么有可能在修改头结点时，会将整个缓存行锁定，使得其他CPU无法访问尾节点，导致效率低下。<br>在PaddedAtomicReference内部类中将共享变量追加到64字节，使得头结点和尾节点不会加载同一个缓存行，即不会互相锁定。</p><p><strong>不适合使用这种优化的情景</strong></p><ol><li>缓存行非64字节的CPU</li><li>共享变量不会被频繁地写</li></ol><h2 id="synchronized"><a href="#synchronized" class="headerlink" title="synchronized"></a>synchronized</h2><p><a href="http://www.cnblogs.com/paddix/p/5405678.html" target="_blank" rel="external">liuxiaopeng | Java并发编程：Synchronized底层优化（偏向锁、轻量级锁）</a></p><h2 id="原子操作"><a href="#原子操作" class="headerlink" title="原子操作"></a>原子操作</h2><blockquote><p>不可被中断的一个或一系列操作</p></blockquote><h3 id="CPU实现原子操作"><a href="#CPU实现原子操作" class="headerlink" title="CPU实现原子操作"></a>CPU实现原子操作</h3><h4 id="总线锁定"><a href="#总线锁定" class="headerlink" title="总线锁定"></a>总线锁定</h4><p>使用CPU提供的一个LOCK#信号，当一个CPU在总线上输出此信号时，其他CPU的请求将会被阻塞，那么该CPU就能独享共享内存了</p><h4 id="缓存锁定"><a href="#缓存锁定" class="headerlink" title="缓存锁定"></a>缓存锁定</h4><p>内存区域如果被缓存在处理器的缓存行中，并且在Lock操作期间被锁定，那么当它执行锁操作回写到内存时，处理器不需要在总线上声言LOCK#信号，而是修改内部的内存地址，通过缓存一致性机制保证操作的原子性。<br>例外：当操作的数据不能被缓存在处理器内部，或操作的数据跨多个缓存行，处理器会调用总线锁定。或者处理器不支持缓存</p><h3 id="Java实现原子操作"><a href="#Java实现原子操作" class="headerlink" title="Java实现原子操作"></a>Java实现原子操作</h3><h4 id="循环CAS（CompareAndSet-CompareAndSwap）"><a href="#循环CAS（CompareAndSet-CompareAndSwap）" class="headerlink" title="循环CAS（CompareAndSet|CompareAndSwap）"></a>循环CAS（CompareAndSet|CompareAndSwap）</h4><p>jvm中的CAS操作是基于处理器的CMPXCHG指令实现的，CAS存在三个问题：</p><ol><li>ABA问题（解决：使用版本号A-B-A变成1A-2B-3A）</li><li>循环时间长开销大</li><li>只能保证一个共享变量的原子操作（解决：AtomicReference类将多个变量放到一个对象中进行CAS操作）</li></ol><h4 id="锁"><a href="#锁" class="headerlink" title="锁"></a>锁</h4><p>锁机制保证了只有获得锁的线程才能操作锁定的内存区域</p>]]></content>
    
    <summary type="html">
    
      
      
        &lt;a id=&quot;more&quot;&gt;&lt;/a&gt;
&lt;h1 id=&quot;1-并发编程的挑战&quot;&gt;&lt;a href=&quot;#1-并发编程的挑战&quot; class=&quot;headerlink&quot; title=&quot;1.并发编程的挑战&quot;&gt;&lt;/a&gt;1.并发编程的挑战&lt;/h1&gt;&lt;h2 id=&quot;什么是上下文切换&quot;&gt;&lt;a href=&quot;
      
    
    </summary>
    
    
      <category term="Java" scheme="http://yoursite.com/tags/Java/"/>
    
      <category term="Java并发" scheme="http://yoursite.com/tags/Java%E5%B9%B6%E5%8F%91/"/>
    
      <category term="读薄系列" scheme="http://yoursite.com/tags/%E8%AF%BB%E8%96%84%E7%B3%BB%E5%88%97/"/>
    
  </entry>
  
  <entry>
    <title>Hibernate缓存小结</title>
    <link href="http://yoursite.com/2017/05/03/Hibernate%E7%BC%93%E5%AD%98%E5%B0%8F%E7%BB%93/"/>
    <id>http://yoursite.com/2017/05/03/Hibernate缓存小结/</id>
    <published>2017-05-03T09:17:30.000Z</published>
    <updated>2018-02-08T09:29:20.788Z</updated>
    
    <content type="html"><![CDATA[<a id="more"></a><h2 id="什么是缓存"><a href="#什么是缓存" class="headerlink" title="什么是缓存"></a>什么是缓存</h2><blockquote><p>缓存是介于应用程序和物理数据源之间，其作用是为了降低应用程序对物理数据源访问的频次，从而提高了应用的运行性能。缓存内的数据是对物理数据源中的数据的复制，应用程序在运行时从缓存读写数据，在特定的时刻或事件会同步缓存和物理数据源的数据。</p></blockquote><h2 id="一级缓存（会话级）"><a href="#一级缓存（会话级）" class="headerlink" title="一级缓存（会话级）"></a>一级缓存（会话级）</h2><ol><li>存放在session中，数据适用范围在当前session内</li><li>生命周期与当前session相同</li><li>默认启用</li><li>evict()方法：用于将某个对象从Session的一级缓存中清除</li><li>clear()方法：用于将一级缓存中的所有对象全部清楚</li></ol><h2 id="二级缓存（应用级）"><a href="#二级缓存（应用级）" class="headerlink" title="二级缓存（应用级）"></a>二级缓存（应用级）</h2><ol><li>数据可使用范围是当前应用的所有会话</li><li>默认不启用，选择性开启（默认是EHCache，其他二级缓存组件如：HashTable、OSCache、SwarmCache等。）</li><li>由sessionFactory控制</li></ol><h2 id="N-1次问题"><a href="#N-1次问题" class="headerlink" title="N+1次问题"></a>N+1次问题</h2><p>订单表(ORDERS)</p><table><thead><tr><th>ID</th><th>ORDER_NUMBER</th><th>CUSTOMER_ID</th></tr></thead><tbody><tr><td>1</td><td>TOM</td><td>1</td></tr><tr><td>2</td><td>TOM</td><td>1</td></tr><tr><td>3</td><td>JAY</td><td>2</td></tr><tr><td>4</td><td>ALICE</td><td>3</td></tr></tbody></table><p>客户表(CUSTOMERS)</p><table><thead><tr><th>ID</th><th>NAME</th></tr></thead><tbody><tr><td>1</td><td>TOM</td></tr><tr><td>2</td><td>JAY</td></tr><tr><td>3</td><td>ALICE</td></tr></tbody></table><p>订单表和客户表是多对一的关系，当检索所有客户时<br>将依次执行以下SQL语句</p><blockquote><p>select <em> from CUSTOMERS;<br>select </em> from ORDERS where CUSTOMER_ID=1;<br>select <em> from ORDERS where CUSTOMER_ID=2;<br>select </em> from ORDERS where CUSTOMER_ID=3;</p></blockquote><h2 id="N-1问题解决方案"><a href="#N-1问题解决方案" class="headerlink" title="N+1问题解决方案"></a>N+1问题解决方案</h2><ol><li>使用表连接查询 <code>select * from CUSTOMERS left outer join ORDERS on CUSTOMERS.ID=ORDERS.CUSTOMER_ID</code></li><li>使用延迟加载 <code>fetch = FetchType.lazy</code></li><li>在关联对象类上标注<code>@BatchSize(size=x)</code> , 设置管理对象查询时一次性查询多少条记录， 使转为为 1+n/x问题。（不推荐）</li></ol><h2 id="适用二级缓存的情况"><a href="#适用二级缓存的情况" class="headerlink" title="适用二级缓存的情况"></a>适用二级缓存的情况</h2><ol><li>数据不会被第三方修改（绕过ORM会使数据不一致）</li><li>数据大小在可接收范围之内（缓存会占用内存资源，占太多反而会降低性能）</li><li>数据更新频率低（频繁的同步缓存中数据也会降低性能）</li><li>非关键数据（正确性 高于 高性能）</li></ol><h2 id="query-list（）和query-iterator（）"><a href="#query-list（）和query-iterator（）" class="headerlink" title="query.list（）和query.iterator（）"></a>query.list（）和query.iterator（）</h2><ol><li>list（）不使用一级缓存，即每次调用都会向底层数据库查询，但是会将结果保存到一级缓存中</li><li>iterator（）会先执行一条语句向数据库取出符合条件的数据id，然后通过id在hibernate的一级缓存中查找是否存在该对象，如果存在则直接取出，如果没有则再次发出一条sql语句通过id取得对象（并且加入到缓存中），这样如果所有的id在缓存中都没有的话就会出现n+1条sql语句的问题。</li></ol>]]></content>
    
    <summary type="html">
    
      
      
        &lt;a id=&quot;more&quot;&gt;&lt;/a&gt;
&lt;h2 id=&quot;什么是缓存&quot;&gt;&lt;a href=&quot;#什么是缓存&quot; class=&quot;headerlink&quot; title=&quot;什么是缓存&quot;&gt;&lt;/a&gt;什么是缓存&lt;/h2&gt;&lt;blockquote&gt;
&lt;p&gt;缓存是介于应用程序和物理数据源之间，其作用是为了降低应
      
    
    </summary>
    
    
      <category term="Hibernate" scheme="http://yoursite.com/tags/Hibernate/"/>
    
  </entry>
  
  <entry>
    <title>可能会发生重定向的情况</title>
    <link href="http://yoursite.com/2017/03/30/%E5%8F%AF%E8%83%BD%E4%BC%9A%E5%8F%91%E7%94%9F%E9%87%8D%E5%AE%9A%E5%90%91%E7%9A%84%E6%83%85%E5%86%B5/"/>
    <id>http://yoursite.com/2017/03/30/可能会发生重定向的情况/</id>
    <published>2017-03-30T11:55:40.000Z</published>
    <updated>2018-02-10T13:56:00.825Z</updated>
    
    <content type="html"><![CDATA[<a id="more"></a><h2 id="一-永久搬离的资源"><a href="#一-永久搬离的资源" class="headerlink" title="一. 永久搬离的资源"></a>一. 永久搬离的资源</h2><p>访问的资源被<strong>（永久性）移动新的位置</strong>或者被<strong>（永久性）重命名</strong>，从而形成新的URL。Web服务器返回重定向响应告诉客户从新的地址获取资源，并且在访问新地址之前更新书签之类的信息。</p><h2 id="二-临时搬离的资源"><a href="#二-临时搬离的资源" class="headerlink" title="二. 临时搬离的资源"></a>二. 临时搬离的资源</h2><p>访问的资源被<strong>临时移走</strong>或<strong>临时重命名</strong>，服务器希望客户端重定向到新的位置上去，但由于资源的改变是临时的，所以服务器希望客户端将来还是可以回头去使用老的URL。不要对书签进行更新</p><h2 id="三-URL增强"><a href="#三-URL增强" class="headerlink" title="三. URL增强"></a>三. URL增强</h2><p>通过重定向来重写URL，往往用于嵌入上下文。[经过扩展和状态增强的URL称为“胖URL”]<br>客户端会跟随这个重定向信息，重新发起请求，但这次的请求会包含完整的、经过状态增强的URL，这是在事务间维护状态的一种有效的方法。</p><h2 id="四-负载均衡"><a href="#四-负载均衡" class="headerlink" title="四. 负载均衡"></a>四. 负载均衡</h2><p>如果一个超载的服务器收到一条请求，服务器可以将客户端的请求重定向到一个负载不太重的服务器上去。</p><h2 id="五-规范目录名称"><a href="#五-规范目录名称" class="headerlink" title="五. 规范目录名称"></a>五. 规范目录名称</h2><p>客户端请求的URI是一个不带尾部斜线的目录吗时，大多数Web服务器会将客户端重定向到一个加了斜线的URI上，这样相对链接就可以正常工作了。</p><h2 id="补充：状态码302，303，307的区别"><a href="#补充：状态码302，303，307的区别" class="headerlink" title="补充：状态码302，303，307的区别"></a>补充：状态码302，303，307的区别</h2><ul><li>302是HTTP/1.0的标准，303，307则是HTTP/1.1标准中对302的细化</li><li>302：如果客户端发出POST请求后，收到服务端的302状态码，那么不能自动的向新的URI发送重复请求，必须跟用户确认是否该重发，因为第二次POST时，环境可能已经发生变化（POST方法不是幂等的），POST操作会不符合用户预期</li><li>303：对于POST请求，它表示请求已经被处理，客户端可以接着使用GET方法去请求Location里的URI</li><li>307：对于POST请求，表示请求还没有被处理，客户端应该向Location里的URI重新发起POST请求</li></ul>]]></content>
    
    <summary type="html">
    
      
      
        &lt;a id=&quot;more&quot;&gt;&lt;/a&gt;
&lt;h2 id=&quot;一-永久搬离的资源&quot;&gt;&lt;a href=&quot;#一-永久搬离的资源&quot; class=&quot;headerlink&quot; title=&quot;一. 永久搬离的资源&quot;&gt;&lt;/a&gt;一. 永久搬离的资源&lt;/h2&gt;&lt;p&gt;访问的资源被&lt;strong&gt;（永久性）移动新
      
    
    </summary>
    
    
  </entry>
  
  <entry>
    <title>[读薄系列]并查集</title>
    <link href="http://yoursite.com/2017/03/24/%E8%AF%BB%E8%96%84%E7%B3%BB%E5%88%97-%E5%B9%B6%E6%9F%A5%E9%9B%86/"/>
    <id>http://yoursite.com/2017/03/24/读薄系列-并查集/</id>
    <published>2017-03-24T14:57:04.000Z</published>
    <updated>2018-02-10T13:55:53.034Z</updated>
    
    <content type="html"><![CDATA[<h2 id="什么是并查集"><a href="#什么是并查集" class="headerlink" title="什么是并查集"></a>什么是并查集</h2><a id="more"></a><p>一种树形结构，用于处理一些<strong>不相交集合</strong>的合并及查询问题<br>主要的两种操作：<br><strong>合并</strong>：合并两个集合<br><strong>查询</strong>：查询两个元素是否属于同一个集合</p><h2 id="存储集合中元素的关系"><a href="#存储集合中元素的关系" class="headerlink" title="存储集合中元素的关系"></a>存储集合中元素的关系</h2><p>用一个数组记录每一个元素的上一级是谁<br>例如fa[1]=2表示1号的上一级是2号<br>如果一个元素的上一级是自己，那么他就是这个集合的“老大”（用来唯一标识这个集合）<br><img src="http://okc9ihakz.bkt.clouddn.com/20170324213741.png?slimimage" alt=""></p><h2 id="查询元素属于哪个集合"><a href="#查询元素属于哪个集合" class="headerlink" title="查询元素属于哪个集合"></a>查询元素属于哪个集合</h2><p>假如现在4号元素想知道他属于哪一个集合，那么他会去问他的上一级，上一级又去问他的上一级，直到集合的“老大”<br><img src="http://okc9ihakz.bkt.clouddn.com/20170324215042.png?slimimage" alt=""><br>查询成功时，会按原路径返回结果<br><img src="http://okc9ihakz.bkt.clouddn.com/20170324215135.png?slimimage" alt=""></p><figure class="highlight c++"><table><tr><td class="gutter"><pre><div class="line">1</div><div class="line">2</div><div class="line">3</div><div class="line">4</div><div class="line">5</div></pre></td><td class="code"><pre><div class="line"><span class="function"><span class="keyword">int</span> <span class="title">find</span><span class="params">(<span class="keyword">int</span> x)</span></span>&#123;</div><div class="line">    <span class="keyword">if</span>(x!=fa[x])</div><div class="line">        <span class="keyword">return</span> find(fa[x]);</div><div class="line">    <span class="keyword">return</span> x;</div><div class="line">&#125;</div></pre></td></tr></table></figure><h2 id="合并两个集合"><a href="#合并两个集合" class="headerlink" title="合并两个集合"></a>合并两个集合</h2><p>假如现在1号和5号所在的集合想合并，两个集合合并必须先问过两个集合的“老大”<br><img src="http://okc9ihakz.bkt.clouddn.com/1.png?slimimage" alt=""><br><img src="http://okc9ihakz.bkt.clouddn.com/2.png?slimimage" alt=""><br><img src="http://okc9ihakz.bkt.clouddn.com/3.png?slimimage" alt=""><br><img src="http://okc9ihakz.bkt.clouddn.com/4.png?slimimage" alt=""><br><img src="http://okc9ihakz.bkt.clouddn.com/5.png?slimimage" alt=""><br><img src="http://okc9ihakz.bkt.clouddn.com/6.png?slimimage" alt=""><br><figure class="highlight c++"><table><tr><td class="gutter"><pre><div class="line">1</div><div class="line">2</div><div class="line">3</div><div class="line">4</div><div class="line">5</div><div class="line">6</div><div class="line">7</div><div class="line">8</div><div class="line">9</div></pre></td><td class="code"><pre><div class="line"><span class="function"><span class="keyword">bool</span> <span class="title">merge</span><span class="params">(<span class="keyword">int</span> x, <span class="keyword">int</span> y)</span></span>&#123;</div><div class="line">    <span class="keyword">int</span> fx = find(x);<span class="comment">//找“老大”</span></div><div class="line">    <span class="keyword">int</span> fy = find(y);</div><div class="line">    <span class="keyword">if</span>(fx!=fy)&#123;<span class="comment">//不属于同一个集合</span></div><div class="line">        fa[fx] = fy;</div><div class="line">        <span class="keyword">return</span> <span class="literal">true</span>;<span class="comment">//合并成功</span></div><div class="line">    &#125;</div><div class="line">    <span class="keyword">return</span> <span class="literal">false</span>;<span class="comment">//合并失败</span></div><div class="line">&#125;</div></pre></td></tr></table></figure></p><h2 id="路径压缩"><a href="#路径压缩" class="headerlink" title="路径压缩"></a>路径压缩</h2><p>在合并集合的过程是将两个集合的“老大”连接起来，谁当谁的上一级完全随机，所以最后树状结构完全有可能变成链状，这样查找效率就会比较低了。<br>最理想的情况就是所以人的直接上级就是“老大”了，一共两级结构，只有找一次便找到集合“老大”。<br>不一定要完全符合这个结构，只需尽量符合即可。</p><p>还是原来那个查找的例子<br><img src="http://okc9ihakz.bkt.clouddn.com/20170324215042.png?slimimage" alt=""><br>当将结果往下传递的过程中，随带把路径中的元素的直接上一级设为集合“老大”即可。最终变为<br><img src="http://okc9ihakz.bkt.clouddn.com/7.png?slimimage" alt=""></p><figure class="highlight c++"><table><tr><td class="gutter"><pre><div class="line">1</div><div class="line">2</div><div class="line">3</div><div class="line">4</div><div class="line">5</div></pre></td><td class="code"><pre><div class="line"><span class="function"><span class="keyword">int</span> <span class="title">find</span><span class="params">(<span class="keyword">int</span> x)</span></span>&#123;</div><div class="line">    <span class="keyword">if</span>(x!=fa[x])</div><div class="line">        <span class="keyword">return</span> fa[x] = find(fa[x]);</div><div class="line">    <span class="keyword">return</span> x;</div><div class="line">&#125;</div></pre></td></tr></table></figure>]]></content>
    
    <summary type="html">
    
      &lt;h2 id=&quot;什么是并查集&quot;&gt;&lt;a href=&quot;#什么是并查集&quot; class=&quot;headerlink&quot; title=&quot;什么是并查集&quot;&gt;&lt;/a&gt;什么是并查集&lt;/h2&gt;
    
    </summary>
    
    
      <category term="读薄系列" scheme="http://yoursite.com/tags/%E8%AF%BB%E8%96%84%E7%B3%BB%E5%88%97/"/>
    
      <category term="数据结构" scheme="http://yoursite.com/tags/%E6%95%B0%E6%8D%AE%E7%BB%93%E6%9E%84/"/>
    
      <category term="并查集" scheme="http://yoursite.com/tags/%E5%B9%B6%E6%9F%A5%E9%9B%86/"/>
    
  </entry>
  
  <entry>
    <title>[读薄系列]RMQ问题之ST算法</title>
    <link href="http://yoursite.com/2017/03/23/RMQ%E9%97%AE%E9%A2%98%E4%B9%8BST%E7%AE%97%E6%B3%95/"/>
    <id>http://yoursite.com/2017/03/23/RMQ问题之ST算法/</id>
    <published>2017-03-23T01:54:29.000Z</published>
    <updated>2018-02-08T09:30:37.015Z</updated>
    
    <content type="html"><![CDATA[<a id="more"></a><h2 id="什么是ST算法"><a href="#什么是ST算法" class="headerlink" title="什么是ST算法"></a>什么是ST算法</h2><p>ST（Sparse Table，稀疏表）是解决RMQ问题的经典在线算法<br>O(NlogN)预处理<br>O(1)查询<br>本质就是动态规划算法</p><h2 id="预处理"><a href="#预处理" class="headerlink" title="预处理"></a>预处理</h2><p>维护二维数组ST[n][n]，ST[i][j]表示i开始，长度为2<sup>j</sup>的子数组中的最值<br>在求ST[i][j]的最值时，将这段子数组切成两半，每段长度为2<sup>j-1</sup>，于是前面一段的最值为ST[i][j-1]，后面一段的最值为ST[i+2<sup>j-1</sup>][j-1]，即状态转移方程为<br><strong>ST[i][j] = max(ST[i][j-1], ST[i+2<sup>j-1</sup>][j-1])</strong></p><figure class="highlight c++"><table><tr><td class="gutter"><pre><div class="line">1</div><div class="line">2</div><div class="line">3</div><div class="line">4</div><div class="line">5</div><div class="line">6</div><div class="line">7</div><div class="line">8</div><div class="line">9</div></pre></td><td class="code"><pre><div class="line"><span class="function"><span class="keyword">void</span> <span class="title">initST</span><span class="params">()</span></span>&#123;</div><div class="line">  <span class="keyword">for</span> (<span class="keyword">int</span> i = <span class="number">0</span>; i &lt; n; i++)</div><div class="line">        ST[i][<span class="number">0</span>] = num[i];</div><div class="line">    <span class="keyword">for</span>(<span class="keyword">int</span> j = <span class="number">1</span>; (<span class="number">1</span>&lt;&lt;j) &lt;= n; j++)&#123;<span class="comment">//枚举长度</span></div><div class="line">        <span class="keyword">for</span>(<span class="keyword">int</span> i = <span class="number">0</span>; i + (<span class="number">1</span>&lt;&lt;j) - <span class="number">1</span> &lt; n;i++)&#123;<span class="comment">//枚举起点</span></div><div class="line">            ST[i][j] = max(ST[i][j<span class="number">-1</span>], ST[i+(<span class="number">1</span>&lt;&lt;(j<span class="number">-1</span>))][j<span class="number">-1</span>]);</div><div class="line">        &#125;</div><div class="line">    &#125;</div><div class="line">&#125;</div></pre></td></tr></table></figure><h2 id="查询"><a href="#查询" class="headerlink" title="查询"></a>查询</h2><p>由于每次查询的区间长度不一定是偶数，即不能直接用ST[i][j]表示，所以还需进一步处理。<br>对于查询区间[a，b]，我们将其分为两段长度相等（2<sup>k</sup>）的偶数区间,他们可能相交，但不影响最值的求解，即<br>(b-a)/2 ≤ 2<sup>k</sup> ≤ b-a+1<br>所以k的最小值为<strong>log<sub>2</sub>(b-a)</strong><br>即<br><strong>query(a, b) = max(ST[a][k], ST[b - (2<sup>k</sup> + 1)][k])</strong><br><figure class="highlight c++"><table><tr><td class="gutter"><pre><div class="line">1</div><div class="line">2</div><div class="line">3</div><div class="line">4</div></pre></td><td class="code"><pre><div class="line"><span class="function"><span class="keyword">int</span> <span class="title">query</span><span class="params">(<span class="keyword">int</span> a,<span class="keyword">int</span> b)</span></span>&#123;</div><div class="line">    <span class="keyword">int</span> k = (<span class="keyword">int</span>)(<span class="built_in">log</span>(b-a+<span class="number">1.0</span>)/<span class="built_in">log</span>(<span class="number">2.0</span>));</div><div class="line">    <span class="keyword">return</span> max(ST[u][k],ST[b-(<span class="number">1</span>&lt;&lt;k)+<span class="number">1</span>][k]);</div><div class="line">&#125;</div></pre></td></tr></table></figure></p><h2 id="动态修改"><a href="#动态修改" class="headerlink" title="动态修改"></a>动态修改</h2><p>当修改某个位置的数值时，需要将覆盖此位置的所有区间做相应的更新</p><ol><li>更新ST[i][0]</li><li>枚举长度 j=1；2<sup>j</sup> ≤ n；j++</li><li>枚举起点从以i为最后一个元素的区间到以i为起点的区间</li></ol><figure class="highlight c++"><table><tr><td class="gutter"><pre><div class="line">1</div><div class="line">2</div><div class="line">3</div><div class="line">4</div><div class="line">5</div><div class="line">6</div><div class="line">7</div><div class="line">8</div><div class="line">9</div></pre></td><td class="code"><pre><div class="line"><span class="function"><span class="keyword">void</span> <span class="title">update</span><span class="params">(<span class="keyword">int</span> x, <span class="keyword">int</span> y)</span></span>&#123;</div><div class="line">    ST[x][<span class="number">0</span>] = y;</div><div class="line">    <span class="keyword">for</span>(<span class="keyword">int</span> j = <span class="number">1</span>; (<span class="number">1</span>&lt;&lt;j) &lt;= n; j++)&#123;</div><div class="line">        <span class="keyword">for</span>(<span class="keyword">int</span> i = x-(<span class="number">1</span>&lt;&lt;j)+<span class="number">1</span> &gt; <span class="number">1</span> ? x-(<span class="number">1</span>&lt;&lt;j)+<span class="number">1</span> : <span class="number">1</span>; </div><div class="line">        i &lt;= x &amp;&amp; i + (<span class="number">1</span>&lt;&lt;j)<span class="number">-1</span> &lt;= n; </div><div class="line">        i++)</div><div class="line">            ST[i][j] = max(ST[i][j<span class="number">-1</span>], ST[i + (<span class="number">1</span>&lt;&lt;(j<span class="number">-1</span>))][j<span class="number">-1</span>]);</div><div class="line">    &#125;</div><div class="line">&#125;</div></pre></td></tr></table></figure>]]></content>
    
    <summary type="html">
    
      
      
        &lt;a id=&quot;more&quot;&gt;&lt;/a&gt;
&lt;h2 id=&quot;什么是ST算法&quot;&gt;&lt;a href=&quot;#什么是ST算法&quot; class=&quot;headerlink&quot; title=&quot;什么是ST算法&quot;&gt;&lt;/a&gt;什么是ST算法&lt;/h2&gt;&lt;p&gt;ST（Sparse Table，稀疏表）是解决RMQ问题的经典在
      
    
    </summary>
    
    
      <category term="DP" scheme="http://yoursite.com/tags/DP/"/>
    
      <category term="读薄系列" scheme="http://yoursite.com/tags/%E8%AF%BB%E8%96%84%E7%B3%BB%E5%88%97/"/>
    
      <category term="RMQ" scheme="http://yoursite.com/tags/RMQ/"/>
    
      <category term="ST" scheme="http://yoursite.com/tags/ST/"/>
    
  </entry>
  
  <entry>
    <title>[Codeforces777a]Shell Game</title>
    <link href="http://yoursite.com/2017/03/12/Codeforces777a-Shell-Game/"/>
    <id>http://yoursite.com/2017/03/12/Codeforces777a-Shell-Game/</id>
    <published>2017-03-12T04:48:51.000Z</published>
    <updated>2018-02-08T09:28:29.807Z</updated>
    
    <content type="html"><![CDATA[<p><a href="www.codeforces.com/contest/777/problem/A">题目传送门</a><br><a id="more"></a></p><h2 id="题意"><a href="#题意" class="headerlink" title="题意"></a>题意</h2><p>游戏规则：三个杯子一个球，知道杯子交换的次数和最后球所在的位置，问初始球在哪一个杯子中。<br>杯子交换的规制：</p><ol><li>左边杯子和中间的杯子交换（第奇数次交换）</li><li>右边杯子和中间的杯子交换（第偶数次交换）</li></ol><h2 id="思路"><a href="#思路" class="headerlink" title="思路"></a>思路</h2><p>由于杯子数目是固定的，且交换有规则，可以先尝试下前几次交换的情况<br>初始 0 1 2</p><ol><li>第一次交换 1 0 2</li><li>第二次交换 1 2 0</li><li>第三次交换 2 1 0</li><li>第四次交换 2 0 1</li><li>第五次交换 0 2 1</li><li>第六次交换 0 1 2</li></ol><p>发现6次交换后杯子又恢复到初始的位置<br>所以可以将这6种情况的位置情况存到一个二维数组ans[][]，根据交换次数n和最终位置x可得出初始位置是ans[n%6][x]</p><h2 id="代码"><a href="#代码" class="headerlink" title="代码"></a>代码</h2><figure class="highlight c++"><table><tr><td class="gutter"><pre><div class="line">1</div><div class="line">2</div><div class="line">3</div><div class="line">4</div><div class="line">5</div><div class="line">6</div><div class="line">7</div><div class="line">8</div><div class="line">9</div><div class="line">10</div><div class="line">11</div><div class="line">12</div><div class="line">13</div><div class="line">14</div><div class="line">15</div><div class="line">16</div><div class="line">17</div><div class="line">18</div><div class="line">19</div><div class="line">20</div><div class="line">21</div><div class="line">22</div></pre></td><td class="code"><pre><div class="line"><span class="meta">#<span class="meta-keyword">include</span><span class="meta-string">&lt;iostream&gt;</span></span></div><div class="line"><span class="keyword">using</span> <span class="keyword">namespace</span> <span class="built_in">std</span>;</div><div class="line"></div><div class="line"><span class="keyword">int</span> ans[<span class="number">7</span>][<span class="number">3</span>] = &#123;</div><div class="line"><span class="number">0</span>,<span class="number">1</span>,<span class="number">2</span>,</div><div class="line"><span class="number">1</span>,<span class="number">0</span>,<span class="number">2</span>,</div><div class="line"><span class="number">1</span>,<span class="number">2</span>,<span class="number">0</span>,</div><div class="line"><span class="number">2</span>,<span class="number">1</span>,<span class="number">0</span>,</div><div class="line"><span class="number">2</span>,<span class="number">0</span>,<span class="number">1</span>,</div><div class="line"><span class="number">0</span>,<span class="number">2</span>,<span class="number">1</span>,</div><div class="line"><span class="number">0</span>,<span class="number">1</span>,<span class="number">2</span></div><div class="line">&#125;;</div><div class="line"></div><div class="line"><span class="function"><span class="keyword">int</span> <span class="title">main</span><span class="params">()</span> </span>&#123;</div><div class="line">__int64 n;</div><div class="line"><span class="keyword">int</span> x;</div><div class="line"><span class="keyword">while</span> (<span class="built_in">cin</span> &gt;&gt; n &gt;&gt; x) &#123;</div><div class="line">n %= <span class="number">6</span>;</div><div class="line"><span class="built_in">cout</span> &lt;&lt; ans[n][x] &lt;&lt; <span class="built_in">endl</span>;</div><div class="line">&#125;</div><div class="line"><span class="keyword">return</span> <span class="number">0</span>;</div><div class="line">&#125;</div></pre></td></tr></table></figure>]]></content>
    
    <summary type="html">
    
      &lt;p&gt;&lt;a href=&quot;www.codeforces.com/contest/777/problem/A&quot;&gt;题目传送门&lt;/a&gt;&lt;br&gt;
    
    </summary>
    
    
      <category term="CodeForces" scheme="http://yoursite.com/tags/CodeForces/"/>
    
  </entry>
  
  <entry>
    <title>脑力游戏</title>
    <link href="http://yoursite.com/2017/03/11/%E8%84%91%E5%8A%9B%E6%B8%B8%E6%88%8F/"/>
    <id>http://yoursite.com/2017/03/11/脑力游戏/</id>
    <published>2017-03-11T02:04:52.000Z</published>
    <updated>2018-02-10T13:56:21.593Z</updated>
    
    <content type="html"><![CDATA[<h1 id="脑力游戏"><a href="#脑力游戏" class="headerlink" title="脑力游戏"></a>脑力游戏</h1><h2 id="题目大意"><a href="#题目大意" class="headerlink" title="题目大意"></a>题目大意</h2><p>给定n个带锁的盒子和n把钥匙，每把钥匙对应着唯一的一个盒子。初始状态下每把钥匙分别放在不同的盒子中，且所有盒子是上锁的。可以通过“暴力”打开某些盒子，取出放在里面的钥匙，然后利用拿到的钥匙去开相应的盒子。问如果只允许“暴力”打开最多k个盒子，那么在多少种状态下，可以最终打开所有盒子。(1≤n≤100, 0≤k≤n)</p><h2 id="涉及知识点"><a href="#涉及知识点" class="headerlink" title="涉及知识点"></a>涉及知识点</h2><h3 id="置换"><a href="#置换" class="headerlink" title="置换"></a>置换</h3><h4 id="1-什么是置换"><a href="#1-什么是置换" class="headerlink" title="1.什么是置换"></a>1.什么是置换</h4><p>假设S={1,2,3,.., n}，σ是S上的双射函数，则S上的n元置换记为σ<br> $$<br> \left(<br> \begin{matrix}<br> 1 &amp; 2 &amp; … &amp; n \<br> σ(1) &amp; σ(2) &amp; … &amp; σ(n)<br> \end{matrix}<br> \right)<br>$$</p><h4 id="2-什么是轮换"><a href="#2-什么是轮换" class="headerlink" title="2.什么是轮换"></a>2.什么是轮换</h4><p>设σ是S上的n元置换，若σ(i<sub>1</sub>)=i<sub>2</sub>,σ(i<sub>2</sub>)=i<sub>3</sub> ,…, σ(i<sub>k-1</sub>)=i<sub>k</sub>,σ(i<sub>k</sub>)=i<sub>1</sub><br>且保持S中的其他元素不变，则称σ为S上的<strong>k阶轮换</strong>，记作(i<sub>1</sub> i<sub>2</sub> … i<sub>k</sub>),若k=2，称σ为S上的<strong>对换</strong>。</p><h4 id="3-置换和轮换的关系"><a href="#3-置换和轮换的关系" class="headerlink" title="3.置换和轮换的关系"></a>3.置换和轮换的关系</h4><p>任何n元置换可以分解为不相交的轮换之积。<br>$$<br> \left(<br> \begin{matrix}<br> 1 &amp; 2 &amp; 3 &amp; 4 &amp; 5 &amp; 6 &amp; 7 &amp; 8 \<br> 5 &amp; 3 &amp; 6 &amp; 4 &amp; 2 &amp; 1 &amp; 8 &amp; 7<br> \end{matrix}<br> \right)<br>$$<br>拆成(1 5 2 3 6)(4)(7 8)</p><h3 id="动态规划"><a href="#动态规划" class="headerlink" title="动态规划"></a>动态规划</h3><h4 id="1-判断一个问题是否可以用动态规划解决"><a href="#1-判断一个问题是否可以用动态规划解决" class="headerlink" title="1.判断一个问题是否可以用动态规划解决"></a>1.判断一个问题是否可以用动态规划解决</h4><ol><li>具有最优子结构</li><li>具有重叠子问题</li><li>无后效性</li></ol><h4 id="2-什么是最优子结构"><a href="#2-什么是最优子结构" class="headerlink" title="2.什么是最优子结构"></a>2.什么是最优子结构</h4><ol><li>一个问题的最优解包含其子问题的最优解</li><li>局部最优解能解决全局最优解</li></ol><h4 id="3-什么重叠子问题"><a href="#3-什么重叠子问题" class="headerlink" title="3.什么重叠子问题"></a>3.什么重叠子问题</h4><ol><li>每次产生的子问题并不总是新问题，有些子问题会被重复计算多少</li><li>而分治产生的子问题都是相互独立的</li></ol><h4 id="4-什么是无后效性"><a href="#4-什么是无后效性" class="headerlink" title="4.什么是无后效性"></a>4.什么是无后效性</h4><ol><li>某个状态以后的过程不会影响到以前的过程</li></ol><h4 id="5-处理动态规划问题的步骤"><a href="#5-处理动态规划问题的步骤" class="headerlink" title="5.处理动态规划问题的步骤"></a>5.处理动态规划问题的步骤</h4><ol><li>定义最优子结构</li><li>把问题看作多阶段决策的过程来求解问题</li><li>递归定义最优解</li><li>按自定向上的方式解最优解</li></ol><h2 id="解题思路"><a href="#解题思路" class="headerlink" title="解题思路"></a>解题思路</h2><ol><li><p>n把钥匙的不同放置方法实际上对应1~n的不同的排列。</p></li><li><p>第一次暴力打开一个盒子会出现两种情况：</p><ol><li>拿到的钥匙是该暴力打开的盒子的钥匙。</li><li>拿着该钥匙打开另一个盒子，直到拿到第一次暴力打开的那个盒子的钥匙，而这实际上构成了一个循环。</li></ol></li></ol><ol><li><p>根据离散数学的角度，这里的每种排列情况对应着一个置换，每一个循环对应一个轮换。</p></li><li><p>所以问题转化成 n！个n元置换中，有多少个置换可以分解为不超过k个不相交的轮换。由于100！非常大，所以问题不能单纯的暴力算出答案，而且需要高精度整数运算。</p></li><li><p>f[i][j]表示i元置换中可以分解为j个不相交轮换的个数。</p></li><li><p>f[n][1] + f[n][2] + … + f[n][k]即为问题所求。所以预处理求出所有状态，再将符合题目要求的结果求和。</p></li><li><p>状态转移的时候有两种情况：</p><ol><li>前面i-1个元素组成j-1个轮换，第i个元素单独作为一个一元轮换。</li><li>前面i-1个元素组成j个轮换，第i个元素加入到前面的元素组成的某个轮换中，能加入的位置有i-1个。</li></ol></li></ol><ol><li><p>假设现在有3个元素，这会将隔出4个位置 1□2□3□4 但是位置1和位置4所构成的循环是相同的。</p></li><li><p>状态转移方程 f[i][j] = f[i-1][j-1] + f[i-1][j]*(i-1)，特殊边界情况f[0][0]=1,f[0][j]=0。</p></li></ol><h2 id="关键代码"><a href="#关键代码" class="headerlink" title="关键代码"></a>关键代码</h2><figure class="highlight c++"><table><tr><td class="gutter"><pre><div class="line">1</div><div class="line">2</div><div class="line">3</div><div class="line">4</div><div class="line">5</div><div class="line">6</div><div class="line">7</div><div class="line">8</div></pre></td><td class="code"><pre><div class="line"><span class="function"><span class="keyword">void</span> <span class="title">preprocess</span><span class="params">()</span></span>&#123;</div><div class="line">f[<span class="number">0</span>][<span class="number">0</span>] = <span class="number">1</span>;</div><div class="line"><span class="keyword">for</span>(<span class="keyword">int</span> i = <span class="number">1</span>; i &lt;= MAXN; i++)&#123;</div><div class="line"><span class="keyword">for</span>(<span class="keyword">int</span> j = <span class="number">1</span>;j &lt;= MAXN; j++)&#123;</div><div class="line">f[i][j] = f[i<span class="number">-1</span>][j<span class="number">-1</span>] + f[i<span class="number">-1</span>][j]*(i<span class="number">-1</span>);</div><div class="line">&#125;</div><div class="line">&#125;</div><div class="line">&#125;</div></pre></td></tr></table></figure>]]></content>
    
    <summary type="html">
    
      
      
        &lt;h1 id=&quot;脑力游戏&quot;&gt;&lt;a href=&quot;#脑力游戏&quot; class=&quot;headerlink&quot; title=&quot;脑力游戏&quot;&gt;&lt;/a&gt;脑力游戏&lt;/h1&gt;&lt;h2 id=&quot;题目大意&quot;&gt;&lt;a href=&quot;#题目大意&quot; class=&quot;headerlink&quot; title=&quot;题目大意&quot;&gt;&lt;/a
      
    
    </summary>
    
    
      <category term="DP" scheme="http://yoursite.com/tags/DP/"/>
    
      <category term="置换轮换" scheme="http://yoursite.com/tags/%E7%BD%AE%E6%8D%A2%E8%BD%AE%E6%8D%A2/"/>
    
  </entry>
  
</feed>
